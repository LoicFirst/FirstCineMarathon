<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Marathon Cin√©phile ‚Äî Final (corrig√©)</title>
<!-- Google Fonts - Montserrat for modern typography -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* =====================================================
   CSS VARIABLES - Modern Color Palette
   ===================================================== */
:root{
  /* Background colors */
  --bg-top:#0d1117;
  --bg-bottom:#010409;
  --bg-gradient:linear-gradient(180deg, var(--bg-top), var(--bg-bottom));
  
  /* Card and surface colors */
  --card:#161b22;
  --card-hover:#1c2128;
  --card-border:rgba(255,255,255,0.08);
  
  /* Text colors */
  --text-primary:#e6edf3;
  --text-secondary:#8b949e;
  --muted:#8b949e;
  
  /* Accent colors - Modern blue/cyan gradient */
  --accent:#58a6ff;
  --accent-2:#79c0ff;
  --accent-glow:rgba(88,166,255,0.15);
  
  /* Status colors */
  --danger:#f85149;
  --success:#56d364;
  --warning:#d29922;
  
  /* Shadows */
  --shadow-sm:0 1px 2px rgba(0,0,0,0.4);
  --shadow-md:0 4px 12px rgba(0,0,0,0.5);
  --shadow-lg:0 8px 24px rgba(0,0,0,0.6);
  --shadow-xl:0 16px 48px rgba(0,0,0,0.7);
  
  /* Border radius */
  --radius-sm:6px;
  --radius-md:10px;
  --radius-lg:14px;
  --radius-xl:20px;
  
  /* Transitions */
  --transition-fast:0.15s ease;
  --transition-normal:0.25s ease;
  --transition-slow:0.35s ease;
}
/* =====================================================
   BASE STYLES
   ===================================================== */
*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family:'Montserrat', Inter, "Segoe UI", Roboto, Arial, sans-serif;
  color:var(--text-primary);
  background:var(--bg-gradient);
  background-attachment:fixed;
  min-height:100vh;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  padding:16px;
  line-height:1.5;
}

/* =====================================================
   LAYOUT
   ===================================================== */
.container{
  max-width:1200px;
  margin:0 auto;
  position:relative;
}

/* =====================================================
   HEADER - with logo placeholder
   ===================================================== */
header{
  display:flex;
  align-items:center;
  gap:16px;
  padding:12px 0;
  margin-bottom:8px;
}

/* Logo Container - Placeholder for future logo */
.logo-container{
  display:flex;
  align-items:center;
  gap:10px;
}

.logo-placeholder{
  width:40px;
  height:40px;
  border-radius:var(--radius-md);
  background:linear-gradient(135deg, var(--accent), var(--accent-2));
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  box-shadow:var(--shadow-md);
  transition:transform var(--transition-fast), box-shadow var(--transition-fast);
}

.logo-placeholder:hover{
  transform:scale(1.05);
  box-shadow:var(--shadow-lg);
}

.logo{
  font-weight:800;
  font-size:20px;
  background:linear-gradient(90deg, var(--accent), var(--accent-2));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  letter-spacing:-0.5px;
}

/* Navigation Tabs */
.tabs{
  display:flex;
  gap:6px;
  margin-left:16px;
  background:rgba(255,255,255,0.03);
  padding:4px;
  border-radius:var(--radius-lg);
}

.tab-btn{
  background:transparent;
  border:0;
  color:var(--text-secondary);
  padding:10px 16px;
  border-radius:var(--radius-md);
  cursor:pointer;
  font-family:inherit;
  font-weight:500;
  font-size:14px;
  transition:all var(--transition-fast);
}

.tab-btn:hover{
  color:var(--text-primary);
  background:rgba(255,255,255,0.05);
}

.tab-btn.active{
  color:#fff;
  background:linear-gradient(135deg, var(--accent), var(--accent-2));
  font-weight:700;
  box-shadow:var(--shadow-md);
  transform:translateY(-1px);
}

.header-right{
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:10px;
}

/* =====================================================
   FLOATING COUNTER
   ===================================================== */
.floating-counter{
  position:fixed;
  right:20px;
  top:20px;
  background:linear-gradient(180deg, rgba(22,27,34,0.95), rgba(13,17,23,0.95));
  padding:10px 14px;
  border-radius:var(--radius-lg);
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
  border:1px solid var(--card-border);
  box-shadow:var(--shadow-xl);
  display:flex;
  align-items:center;
  gap:12px;
  z-index:9999;
  color:#fff;
  font-weight:700;
  cursor:pointer;
  transition:transform var(--transition-fast), box-shadow var(--transition-fast);
}

.floating-counter:hover{
  transform:translateY(-2px);
  box-shadow:var(--shadow-xl), 0 0 20px var(--accent-glow);
}

.floating-counter .small{
  font-weight:500;
  color:var(--text-primary);
  font-size:13px;
}

.floating-counter button{
  background:linear-gradient(135deg, var(--accent), var(--accent-2));
  color:#000;
  border:0;
  padding:8px 12px;
  border-radius:var(--radius-sm);
  cursor:pointer;
  font-weight:700;
  font-family:inherit;
  font-size:12px;
  box-shadow:var(--shadow-md);
  transition:all var(--transition-fast);
}

.floating-counter button:hover{
  transform:translateY(-2px);
  box-shadow:var(--shadow-lg);
}

/* Pulse animation when counter changes */
.counter-pulse {
  animation: counterPulse 0.32s cubic-bezier(.2,.9,.3,1);
}

@keyframes counterPulse {
  0%   { transform: scale(1); box-shadow:var(--shadow-xl);}
  40%  { transform: scale(1.08); box-shadow:var(--shadow-xl), 0 0 30px var(--accent-glow);}
  100% { transform: scale(1); box-shadow:var(--shadow-xl);}
}

/* =====================================================
   CONTENT CARDS & SECTIONS
   ===================================================== */
.content{
  background:var(--card);
  border-radius:var(--radius-lg);
  padding:20px;
  margin-top:12px;
  border:1px solid var(--card-border);
  box-shadow:var(--shadow-lg);
  opacity:0;
  animation:fadeIn 0.35s ease-out forwards;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(12px)}
  to{opacity:1;transform:translateY(0)}
}

@keyframes fadeOut{
  from{opacity:1;transform:translateY(0)}
  to{opacity:0;transform:translateY(8px)}
}

.section{
  margin:16px 0;
  padding:16px;
  border-radius:var(--radius-md);
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005));
  border:1px solid var(--card-border);
  border-left:4px solid var(--accent);
  transition:all var(--transition-normal);
}

.section:hover{
  box-shadow:var(--shadow-md);
  transform:translateY(-2px);
  border-color:rgba(255,255,255,0.12);
  background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
}

.section-head{
  display:flex;
  align-items:center;
  gap:12px;
  justify-content:space-between;
  flex-wrap:wrap;
}

.section-info{
  display:flex;
  align-items:center;
  gap:12px;
}

.section-title{
  font-size:18px;
  font-weight:700;
  letter-spacing:-0.3px;
}

.section-meta{
  color:var(--muted);
  font-size:13px;
  font-weight:500;
}

/* =====================================================
   FILM ROWS
   ===================================================== */
.film{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px;
  border-radius:var(--radius-sm);
  transition:all var(--transition-fast);
  margin:4px 0;
}

.film:hover{
  background:rgba(255,255,255,0.03);
  transform:translateX(4px);
}

.film img{
  width:64px;
  border-radius:var(--radius-sm);
  flex-shrink:0;
  box-shadow:var(--shadow-sm);
  transition:transform var(--transition-fast);
}

.film:hover img{
  transform:scale(1.02);
}

.poster-mid{
  width:110px;
}

.num{
  min-width:36px;
  text-align:right;
  font-weight:800;
  color:var(--warning);
  margin-right:0;
  font-size:14px;
}

.title{
  font-weight:600;
  color:var(--text-primary);
}

.meta{
  font-size:13px;
  color:var(--muted);
  font-weight:500;
}

.actions{
  margin-left:auto;
  display:flex;
  gap:8px;
  align-items:center;
}

/* Utility class for small text */
.small{
  font-size:13px;
  color:var(--muted);
}

/* Row layout helper */
.row{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}

/* =====================================================
   BUTTONS
   ===================================================== */
.button{
  background:linear-gradient(135deg, var(--accent), var(--accent-2));
  color:#000;
  padding:10px 16px;
  border-radius:var(--radius-sm);
  border:0;
  cursor:pointer;
  font-family:inherit;
  font-weight:600;
  font-size:13px;
  transition:all var(--transition-fast);
  box-shadow:var(--shadow-sm);
}

.button:hover{
  transform:translateY(-2px);
  box-shadow:var(--shadow-md), 0 0 20px var(--accent-glow);
}

.button:active{
  transform:translateY(0);
}

.action-btn{
  background:rgba(255,255,255,0.05);
  color:var(--text-primary);
  border:1px solid var(--card-border);
  padding:8px 12px;
  border-radius:var(--radius-sm);
  cursor:pointer;
  font-family:inherit;
  font-size:13px;
  font-weight:500;
  transition:all var(--transition-fast);
}

.action-btn:hover{
  background:rgba(255,255,255,0.1);
  border-color:rgba(255,255,255,0.15);
  transform:translateY(-1px);
}

.action-delete{
  background:linear-gradient(135deg, var(--danger), #da3633);
  color:#fff;
  border:0;
  padding:8px 12px;
  border-radius:var(--radius-sm);
  cursor:pointer;
  font-family:inherit;
  font-size:13px;
  font-weight:500;
  transition:all var(--transition-fast);
}

.action-delete:hover{
  transform:translateY(-1px);
  box-shadow:0 4px 12px rgba(248,81,73,0.3);
}

/* Success button variant */
.button-success{
  background:linear-gradient(135deg, var(--success), #3fb950);
}

/* =====================================================
   FORM ELEMENTS
   ===================================================== */
input[type=text], select, input[type=date], input{
  padding:10px 14px;
  border-radius:var(--radius-sm);
  border:1px solid var(--card-border);
  background:rgba(0,0,0,0.4);
  color:var(--text-primary);
  min-width:120px;
  font-family:inherit;
  font-size:14px;
  transition:all var(--transition-fast);
}

input:focus, select:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accent-glow);
}

input::placeholder{
  color:var(--muted);
  opacity:0.7;
}

select option{
  background:#0d1117;
  color:var(--text-primary);
}

/* Checkbox styling */
input[type=checkbox]{
  width:18px;
  height:18px;
  accent-color:var(--accent);
  cursor:pointer;
}

/* =====================================================
   INLINE FORMS
   ===================================================== */
.inline-form{
  display:flex;
  gap:10px;
  align-items:center;
  margin-top:12px;
  flex-wrap:wrap;
}

.inline-form input{
  padding:8px 12px;
  border-radius:var(--radius-sm);
  background:rgba(0,0,0,0.4);
  color:var(--text-primary);
  border:1px solid var(--card-border);
}

.add-form{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

/* =====================================================
   LINKS
   ===================================================== */
.wiki-link{
  color:var(--accent-2);
  background:rgba(88,166,255,0.1);
  padding:6px 10px;
  border-radius:var(--radius-sm);
  text-decoration:none;
  display:inline-block;
  font-weight:500;
  font-size:12px;
  transition:all var(--transition-fast);
}

.wiki-link:hover{
  background:rgba(88,166,255,0.2);
  transform:translateY(-1px);
}

.watch-link{
  color:#ff7eb3;
  background:rgba(255,126,179,0.1);
  padding:6px 10px;
  border-radius:var(--radius-sm);
  text-decoration:none;
  display:inline-block;
  cursor:pointer;
  font-weight:500;
  font-size:12px;
  transition:all var(--transition-fast);
}

.watch-link:hover{
  background:rgba(255,126,179,0.2);
  transform:translateY(-1px);
}

/* =====================================================
   MANAGE SECTION
   ===================================================== */
.manage-header{
  margin-bottom:24px;
}

.manage-title-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:20px;
  flex-wrap:wrap;
  gap:16px;
}

.manage-stats{
  display:flex;
  gap:12px;
  font-size:14px;
  color:var(--muted);
}

.manage-stats .stat{
  background:rgba(255,255,255,0.03);
  padding:8px 14px;
  border-radius:var(--radius-sm);
  display:flex;
  align-items:center;
  gap:8px;
  border:1px solid var(--card-border);
}

.manage-stats .stat-value{
  font-weight:700;
  color:var(--accent);
}

.manage-actions-row{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
}

.manage-create-section{
  display:flex;
  gap:10px;
  flex:1;
  min-width:280px;
}

.manage-create-section input{
  flex:1;
  min-width:180px;
}

.manage-sections-grid{
  display:grid;
  gap:16px;
}

.manage-section-card{
  background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
  border-radius:var(--radius-md);
  border:1px solid var(--card-border);
  overflow:hidden;
  transition:all var(--transition-normal);
}

.manage-section-card:hover{
  border-color:rgba(255,255,255,0.12);
  box-shadow:var(--shadow-md);
  transform:translateY(-2px);
}

.manage-section-card.expanded{
  border-color:var(--accent);
  box-shadow:var(--shadow-lg), 0 0 20px var(--accent-glow);
}

.manage-card-header{
  display:flex;
  align-items:center;
  padding:16px 20px;
  cursor:pointer;
  gap:14px;
  transition:background var(--transition-fast);
}

.manage-card-header:hover{
  background:rgba(255,255,255,0.02);
}

.manage-card-icon{
  font-size:22px;
  width:36px;
  text-align:center;
}

.manage-card-info{
  flex:1;
}

.manage-card-title{
  font-weight:700;
  font-size:16px;
  margin-bottom:4px;
}

.manage-card-meta{
  font-size:12px;
  color:var(--muted);
  display:flex;
  gap:14px;
}

.manage-card-meta span{
  display:flex;
  align-items:center;
  gap:5px;
}

.manage-card-actions{
  display:flex;
  gap:8px;
}

.manage-card-btn{
  background:rgba(255,255,255,0.06);
  border:none;
  color:var(--text-primary);
  padding:10px 14px;
  border-radius:var(--radius-sm);
  cursor:pointer;
  font-family:inherit;
  font-size:13px;
  font-weight:500;
  display:flex;
  align-items:center;
  gap:5px;
  transition:all var(--transition-fast);
}

.manage-card-btn:hover{
  background:rgba(255,255,255,0.12);
  transform:translateY(-1px);
}

.manage-card-btn.danger{
  background:rgba(248,81,73,0.15);
  color:var(--danger);
}

.manage-card-btn.danger:hover{
  background:rgba(248,81,73,0.25);
}

.manage-card-expand{
  background:none;
  border:none;
  color:var(--muted);
  padding:10px;
  cursor:pointer;
  transition:transform var(--transition-normal);
}

.manage-card-expand.expanded{
  transform:rotate(180deg);
}

.manage-card-films{
  max-height:0;
  overflow:hidden;
  transition:max-height var(--transition-slow) ease;
  background:rgba(0,0,0,0.2);
}

.manage-card-films.expanded{
  max-height:500px;
  overflow-y:auto;
}

.manage-film-item{
  display:flex;
  align-items:center;
  padding:12px 20px;
  gap:12px;
  border-top:1px solid var(--card-border);
  transition:background var(--transition-fast);
}

.manage-film-item:hover{
  background:rgba(255,255,255,0.03);
}

.manage-film-poster{
  width:40px;
  height:60px;
  border-radius:var(--radius-sm);
  object-fit:cover;
  background:#1a2230;
  box-shadow:var(--shadow-sm);
}

.manage-film-info{
  flex:1;
  min-width:0;
}

.manage-film-title{
  font-weight:600;
  font-size:14px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.manage-film-meta{
  font-size:12px;
  color:var(--muted);
}

.manage-film-actions{
  display:flex;
  gap:6px;
}

.manage-film-btn{
  background:none;
  border:none;
  color:var(--muted);
  padding:6px 8px;
  cursor:pointer;
  border-radius:var(--radius-sm);
  font-size:13px;
  transition:all var(--transition-fast);
}

.manage-film-btn:hover{
  background:rgba(255,255,255,0.08);
  color:var(--text-primary);
}

.manage-empty{
  text-align:center;
  padding:48px;
  color:var(--muted);
}

.manage-empty-icon{
  font-size:56px;
  margin-bottom:16px;
  opacity:0.5;
}

/* =====================================================
   CAROUSEL
   ===================================================== */
.carousel-wrap{
  position:relative;
  overflow:hidden;
  border-radius:var(--radius-lg);
  margin-top:16px;
  height:220px;
  border:1px solid var(--card-border);
}

.carousel-bg{
  position:absolute;
  inset:0;
  filter:blur(20px) saturate(70%);
  opacity:0.15;
  background-size:cover;
  background-position:center;
  z-index:0;
}

.carousel-viewport{
  position:relative;
  z-index:2;
  height:100%;
  overflow:hidden;
}

.carousel-track{
  display:flex;
  gap:14px;
  align-items:center;
  height:100%;
  padding:16px;
  will-change:transform;
}

.carousel-track img{
  height:180px;
  border-radius:var(--radius-md);
  flex-shrink:0;
  box-shadow:var(--shadow-lg);
  transition:transform var(--transition-normal);
}

.carousel-track img:hover{
  transform:scale(1.05);
}

/* =====================================================
   ANIMATIONS
   ===================================================== */
/* Pop animation on check */
.checked-pop {
  animation:pop-check 0.25s cubic-bezier(.2,.9,.3,1);
}

@keyframes pop-check{
  0%{transform:scale(1);opacity:1}
  45%{transform:scale(1.03);opacity:1}
  100%{transform:scale(1);opacity:1}
}

/* =====================================================
   STAR RATING SYSTEM
   ===================================================== */
.star-rating{
  display:inline-flex;
  align-items:center;
  gap:2px;
  margin-left:12px;
  cursor:pointer;
  user-select:none;
  --star-stroke-width:1.5;
}

.star{
  position:relative;
  width:20px;
  height:20px;
  display:inline-block;
  transition:transform var(--transition-fast);
}

.star svg{
  width:100%;
  height:100%;
  fill:transparent;
  stroke:#ffd700;
  stroke-width:var(--star-stroke-width);
}

.star.filled svg{
  fill:#ffd700;
  stroke:#ffb700;
  stroke-width:var(--star-stroke-width);
}

.star.half-filled svg{
  fill:url(#half-gradient);
  stroke:#ffb700;
  stroke-width:var(--star-stroke-width);
}

.star:hover{
  transform:scale(1.2);
}

.star-rating:active .star{
  transform:scale(0.95);
}

/* Star animation on selection */
@keyframes star-pop{
  0%{transform:scale(1)}
  50%{transform:scale(1.35)}
  100%{transform:scale(1)}
}

.star.animate{
  animation:star-pop 0.3s ease;
}

/* =====================================================
   RESPONSIVE - Tablet (max 900px)
   ===================================================== */
@media(max-width:900px){
  .tabs{
    overflow-x:auto;
    white-space:nowrap;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:none;
  }
  
  .tabs::-webkit-scrollbar{
    display:none;
  }
  
  .carousel-track img{
    height:140px;
  }
  
  .floating-counter{
    right:10px;
    left:auto;
    top:10px;
    padding:8px 10px;
  }
}

/* =====================================================
   RESPONSIVE - Small Tablet (max 768px)
   ===================================================== */
@media(max-width:768px){
  body{
    padding:8px;
  }
  
  .container{
    max-width:100%;
    padding:0;
  }
  
  /* Header - stack elements */
  header{
    flex-wrap:wrap;
    gap:8px;
    padding:8px 0;
  }
  
  .logo-container{
    width:100%;
    justify-content:center;
    margin-bottom:4px;
  }
  
  .logo-placeholder{
    width:36px;
    height:36px;
    font-size:18px;
  }
  
  .logo{
    font-size:18px;
  }
  
  .tabs{
    flex:1 1 100%;
    order:3;
    gap:4px;
    margin-left:0;
    padding:4px;
  }
  
  .tab-btn{
    padding:8px 12px;
    font-size:12px;
  }
  
  .header-right{
    gap:6px;
    width:100%;
    justify-content:center;
    order:2;
  }
  
  .button{
    padding:8px 12px;
    font-size:12px;
  }
  
  /* Floating counter - move to bottom */
  .floating-counter{
    padding:6px 10px;
    font-size:12px;
    right:8px;
    top:auto;
    bottom:8px;
  }
  
  .floating-counter .small{
    font-size:11px;
  }
  
  .floating-counter button{
    padding:6px 10px;
    font-size:11px;
  }
  
  /* Content - more compact */
  .content{
    padding:12px;
    margin-top:8px;
  }
  
  .section{
    margin:10px 0;
    padding:10px;
  }
  
  .section-head{
    flex-direction:column;
    align-items:flex-start;
    gap:8px;
  }
  
  .section-title{
    font-size:16px;
  }
  
  .section-meta{
    font-size:11px;
  }
  
  /* Film rows - compact */
  .film{
    padding:6px;
    gap:4px;
  }
  
  .film input[type=checkbox]{
    width:16px;
    height:16px;
    margin:0;
    margin-right:-24px;
    flex-shrink:0;
  }
  
  .film img{
    width:48px;
    margin-left:4px;
  }
  
  .film img + div{
    margin-left:8px;
  }
  
  .poster-mid{
    width:72px;
  }
  
  .num{
    min-width:24px;
    font-size:12px;
    margin-right:-22px;
  }
  
  .title{
    font-size:13px;
  }
  
  .meta{
    font-size:11px;
  }
  
  .actions{
    gap:4px;
    flex-wrap:wrap;
  }
  
  .action-btn,.action-delete{
    padding:5px 8px;
    font-size:11px;
  }
  
  /* Forms */
  input, input[type=text], select, input[type=date]{
    font-size:13px;
    padding:8px 10px;
  }
  
  .inline-form{
    flex-direction:column;
    gap:8px;
  }
  
  .inline-form input, .inline-form button{
    width:100%;
  }
  
  .add-form{
    gap:8px;
  }
  
  .add-form input, .add-form select, .add-form button{
    width:100%;
    font-size:13px;
    padding:8px 10px;
  }
  
  /* Stars */
  .star{
    width:18px;
    height:18px;
  }
  
  /* Carousel */
  .carousel-wrap{
    height:180px;
  }
  
  .carousel-track img{
    height:150px;
  }
  
  /* Manage section */
  .manage-title-row{
    flex-direction:column;
    align-items:flex-start;
  }
  
  .manage-stats{
    flex-wrap:wrap;
  }
  
  .manage-actions-row{
    flex-direction:column;
  }
  
  .manage-create-section{
    width:100%;
  }
}

/* =====================================================
   RESPONSIVE - Mobile (max 480px)
   ===================================================== */
@media(max-width:480px){
  body{
    padding:4px;
  }
  
  .logo-placeholder{
    width:32px;
    height:32px;
    font-size:16px;
  }
  
  .logo{
    font-size:16px;
  }
  
  .tab-btn{
    padding:6px 10px;
    font-size:11px;
  }
  
  .button{
    padding:6px 10px;
    font-size:11px;
  }
  
  .section{
    padding:8px;
    margin:6px 0;
  }
  
  .section-title{
    font-size:14px;
  }
  
  .section-meta{
    font-size:10px;
  }
  
  .film{
    padding:4px;
    gap:2px;
  }
  
  .film input[type=checkbox]{
    width:14px;
    height:14px;
    margin-right:-22px;
  }
  
  .film img{
    width:40px;
    margin-left:2px;
  }
  
  .film img + div{
    margin-left:6px;
  }
  
  .poster-mid{
    width:56px;
  }
  
  .num{
    min-width:20px;
    font-size:11px;
    margin-right:-20px;
  }
  
  .title{
    font-size:12px;
  }
  
  .meta{
    font-size:10px;
  }
  
  .actions{
    gap:3px;
  }
  
  .action-btn,.action-delete{
    padding:4px 6px;
    font-size:10px;
  }
  
  .wiki-link, .watch-link{
    padding:4px 6px;
    font-size:10px;
  }
  
  input, input[type=text], select, input[type=date]{
    font-size:12px;
    padding:6px 8px;
  }
  
  .star{
    width:16px;
    height:16px;
  }
  
  .carousel-wrap{
    height:160px;
  }
  
  .carousel-track img{
    height:130px;
  }
  
  /* Floating counter - even more compact */
  .floating-counter{
    padding:5px 8px;
    font-size:11px;
    gap:8px;
  }
  
  .floating-counter .small{
    font-size:10px;
  }
  
  .floating-counter button{
    padding:5px 8px;
    font-size:10px;
  }
}
</style>
</head>
<body>
<svg width="0" height="0" style="position:absolute">
  <defs>
    <linearGradient id="half-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="50%" stop-color="#ffd700"/>
      <stop offset="50%" stop-color="transparent"/>
    </linearGradient>
  </defs>
</svg>
<div class="container">
  <header>
    <!-- Logo Container with placeholder for future logo -->
    <div class="logo-container">
      <div class="logo-placeholder" title="Espace r√©serv√© pour le logo">üé¨</div>
      <div class="logo">Marathon Cin√©phile</div>
    </div>
    <nav class="tabs" role="navigation" aria-label="Navigation principale">
      <button class="tab-btn active" data-tab="all">Tous les films</button>
      <button class="tab-btn" data-tab="seen">Films vus</button>
      <button class="tab-btn" data-tab="manage">Sections & gestion</button>
      <button class="tab-btn" data-tab="tmdb">Derniers films (TMDB)</button>
    </nav>

    <div class="header-right">
      <button id="header-add-btn" class="button" title="Ajouter un film">‚ûï Ajouter</button>
      <button id="exportBtn" class="button" title="Exporter la sauvegarde">Exporter</button>
      <label class="button" style="cursor:pointer"><input id="importFile" type="file" accept="application/json" style="display:none">Importer</label>
    </div>
  </header>

  <div class="floating-counter" id="floatingCounter" title="Cliquer pour ouvrir Films vus">
    <div style="display:flex;align-items:center;gap:8px">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:0.95"><path d="M12 2v6" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 12h12" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div class="small" id="floatingText">Vus : 0 / 0</div>
    </div>
    <button id="floatingAddBtn" title="Ajouter un film">Ajouter</button>
  </div>

  <!-- ALL -->
  <main>
  <section id="all" class="content" data-tabcontent>
    <div class="row" style="margin-bottom:12px;display:flex;gap:10px;flex-wrap:wrap">
      <input id="all-search" type="text" placeholder="Rechercher un film, r√©alisateur ou section..." style="flex:1;min-width:220px" aria-label="Rechercher">
      <button id="all-reset-btn" class="button">R√©initialiser</button>
    </div>

    <div id="all-sections"></div>

    <!-- Global add film form at bottom -->
    <article class="section" id="global-add-film" style="margin-top:18px">
      <h3>Ajouter un film</h3>
      <div class="add-form" style="align-items:center">
        <input id="add-title" type="text" placeholder="Titre" aria-label="Titre du film">
        <input id="add-director" type="text" placeholder="R√©alisateur" aria-label="R√©alisateur">
        <input id="add-year" type="text" placeholder="Ann√©e" aria-label="Ann√©e">
        <input id="add-wiki" type="text" placeholder="Wiki (optionnel)" aria-label="Lien Wikipedia">
        <select id="add-section-select" aria-label="Section"></select>
        <button id="add-film-btn" class="button">Ajouter</button>
      </div>
    </article>
  </section>

  <!-- SEEN -->
  <section id="seen" class="content" style="display:none" data-tabcontent>
    <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap">
      <h3>Films vus</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="seen-add-btn" class="button">Ajouter un film</button>
      </div>
    </div>
    <div id="seen-list" class="small">(Aucun film coch√©)</div>
  </section>

  <!-- MANAGE -->
  <section id="manage" class="content" style="display:none" data-tabcontent>
    <div class="manage-header">
      <div class="manage-title-row">
        <h3 style="margin:0">üìÅ Gestion des sections</h3>
        <div class="manage-stats" id="manage-stats"></div>
      </div>
      <div class="manage-actions-row">
        <div class="manage-create-section">
          <input id="new-section" type="text" placeholder="Nouvelle section..." aria-label="Nom de la nouvelle section">
          <button id="create-section" class="button">‚ûï Cr√©er</button>
        </div>
        <button id="manage-add-btn" class="button button-success">üé¨ Ajouter un film</button>
      </div>
    </div>
    <div id="manage-list" class="manage-sections-grid"></div>
  </section>

  <!-- TMDB -->
  <section id="tmdb" class="content" style="display:none" data-tabcontent>
    <h3>Derniers films (TMDB)</h3>
    <div class="row" style="margin-bottom:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <select id="tmdb-source" aria-label="Source TMDB">
        <option value="all">Toutes sources</option>
        <option value="now_playing">En salle</option>
        <option value="upcoming">√Ä venir</option>
        <option value="popular">Populaires</option>
        <option value="recent">Sorties r√©centes</option>
      </select>
      <select id="tmdb-genre" aria-label="Genre"><option value="">Tous genres</option></select>
      <input id="tmdb-date" type="date" title="Date min" aria-label="Date minimum">
      <input id="tmdb-search" type="text" placeholder="Rechercher TMDB..." style="min-width:180px" aria-label="Rechercher sur TMDB">
      <button id="tmdb-filter" class="button">Filtrer</button>
      <button id="tmdb-refresh" class="button">Rafra√Æchir</button>
      <div style="margin-left:auto" class="small">Donn√©es : TMDB</div>
    </div>

    <div class="carousel-wrap" id="carousel-wrap">
      <div class="carousel-bg" id="carousel-bg"></div>
      <div class="carousel-viewport">
        <div class="carousel-track" id="carousel-track"></div>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <button id="tmdb-sub-all" class="action-btn active">Tous</button>
      <button id="tmdb-sub-watched" class="action-btn">Films TMDB vus</button>
    </div>
    <div id="tmdb-all-container" style="margin-top:12px"></div>
    <div id="tmdb-watched-container" style="display:none;margin-top:8px"></div>

    <div id="tmdb-list" style="margin-top:12px"></div>
  </section>
  </main>
</div>

<script>
/* ================== Config ================== */
const TMDB_API_KEY = '6011d5c690ff0dbf094bd1fcbbc6d336';
const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/';
const STORAGE_KEY = 'marathon_cine_v2';

/* Helpers */
const el = (t, c, txt) => { const e=document.createElement(t); if(c) e.className=c; if(typeof txt!=='undefined') e.textContent=txt; return e; };
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));

/* Generate watchseries.bar URL from title and TMDB ID */
function generateWatchseriesUrl(title, tmdbId) {
  if (!tmdbId) return null;
  const slug = (title || '')
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '');
  return `https://watchseries.bar/movie/${slug}/${tmdbId}`;
}

/* Generate watchseries.bar search URL as fallback */
function generateWatchseriesSearchUrl(title) {
  // Create search query with title only (year doesn't work in watchseries search)
  const query = (title || '').trim();
  return `https://watchseries.bar/search/${encodeURIComponent(query)}`
}

/* Open watchseries.bar for a film */
async function openWatchseries(title, tmdbId, year) {
  if (tmdbId) {
    const url = generateWatchseriesUrl(title, tmdbId);
    if (url) window.open(url, '_blank');
  } else {
    // Try to fetch TMDB ID first, passing year for better matching
    const details = await fetchTMDBDetailsByTitle(title, year);
    if (details && details.tmdbId) {
      const url = generateWatchseriesUrl(title, details.tmdbId);
      if (url) window.open(url, '_blank');
    } else {
      // Fallback: open watchseries.bar search with title only
      const searchUrl = generateWatchseriesSearchUrl(title);
      window.open(searchUrl, '_blank');
    }
  }
}

/* Star Rating Component */
function createStarRating(currentRating, onChange){
  const container = el('div', 'star-rating');
  const stars = [];
  let lockedRating = currentRating || 0; // Track the locked rating value
  
  // Create 5 stars
  for(let i = 0; i < 5; i++){
    const star = el('span', 'star');
    star.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;
    stars.push(star);
    container.appendChild(star);
  }
  
  // Update star display based on rating
  function updateStars(rating){
    const fullStars = Math.floor(rating);
    const hasHalf = (rating % 1) >= 0.5;
    
    stars.forEach((star, i) => {
      star.classList.remove('filled', 'half-filled', 'animate');
      if(i < fullStars){
        star.classList.add('filled');
      } else if(i === fullStars && hasHalf){
        star.classList.add('half-filled');
      }
    });
  }
  
  updateStars(lockedRating);
  
  // Click to set rating with half-star support
  stars.forEach((star, index) => {
    star.addEventListener('click', (e) => {
      e.stopPropagation();
      const rect = star.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const isLeftHalf = x < rect.width / 2;
      const newRating = index + (isLeftHalf ? 0.5 : 1);
      
      // Lock the rating after click
      lockedRating = newRating;
      
      // Animate the clicked star
      star.classList.add('animate');
      setTimeout(() => star.classList.remove('animate'), 300);
      
      updateStars(newRating);
      if(onChange) onChange(newRating);
    });
  });
  
  // Cache star rectangles for better performance
  let starRects = null;
  function cacheStarRects(){
    starRects = stars.map(s => s.getBoundingClientRect());
  }
  
  // Mouse tracking for preview - works on the entire container
  container.addEventListener('mouseenter', cacheStarRects);
  
  container.addEventListener('mousemove', (e) => {
    if(!starRects) cacheStarRects();
    
    // Find which star we're hovering over
    let hoveredStarIndex = -1;
    let isLeftHalf = false;
    
    for(let i = 0; i < starRects.length; i++){
      const rect = starRects[i];
      if(e.clientX >= rect.left && e.clientX <= rect.right &&
         e.clientY >= rect.top && e.clientY <= rect.bottom){
        hoveredStarIndex = i;
        const x = e.clientX - rect.left;
        isLeftHalf = x < rect.width / 2;
        break;
      }
    }
    
    if(hoveredStarIndex >= 0){
      // Show preview
      stars.forEach((s, i) => {
        s.classList.remove('filled', 'half-filled');
        if(i < hoveredStarIndex){
          s.classList.add('filled');
        } else if(i === hoveredStarIndex){
          if(isLeftHalf){
            s.classList.add('half-filled');
          } else {
            s.classList.add('filled');
          }
        }
      });
    }
  });
  
  // Mouse leave container to restore locked state
  container.addEventListener('mouseleave', () => {
    starRects = null; // Clear cache
    updateStars(lockedRating);
  });
  
  return container;
}

/* Initial data */
let initialSections = [
  {
    "section": "PARTIE 1 ‚Äî Grands classiques",
    "color": "#FF6B6B",
    "films": [
      {
        "title": "Lawrence of Arabia",
        "director": "David Lean",
        "year": "1962",
        "wiki": "https://fr.wikipedia.org/wiki/Lawrence_d%27Arabie",
        "poster": "https://image.tmdb.org/t/p/w300/jEXGkKEIuyc6012BFpFJpaGOW5a.jpg",
        "seen": false
      },
      {
        "title": "Oldboy",
        "director": "Park Chan-wook",
        "year": 2003,
        "wiki": "https://fr.wikipedia.org/wiki/Oldboy_(film,_2003)",
        "poster": "https://image.tmdb.org/t/p/w300/5ArcFdLrYZMFgQmRA2BdTYq9CPy.jpg",
        "seen": false
      },
      {
        "title": "Mulholland Drive",
        "director": "David Lynch",
        "year": 2001,
        "wiki": "https://fr.wikipedia.org/wiki/Mulholland_Drive",
        "poster": "https://image.tmdb.org/t/p/w300/x4ZLWoqsXFrkwA1m1T3OQg4P5Z7.jpg",
        "seen": false
      },
      {
        "title": "Taxi Driver",
        "director": "Martin Scorsese",
        "year": 1976,
        "wiki": "https://fr.wikipedia.org/wiki/Taxi_Driver",
        "poster": "https://image.tmdb.org/t/p/w300/iyHQrfNsjZlfHJ8hyhNi0yAFnZa.jpg",
        "seen": false
      },
      {
        "title": "Kill Bill Vol. 1",
        "director": "Quentin Tarantino",
        "year": 2003,
        "wiki": "https://fr.wikipedia.org/wiki/Kill_Bill",
        "poster": "https://image.tmdb.org/t/p/w300/udRaQKzT0LG4iQFxHLaYjno9uAT.jpg"
      },
      {
        "title": "Requiem for a Dream",
        "director": "Darren Aronofsky",
        "year": 2000,
        "wiki": "https://fr.wikipedia.org/wiki/Requiem_for_a_Dream",
        "poster": "https://image.tmdb.org/t/p/w300/zRqCRaYXUnAtBBuU1J3DVA4yc5V.jpg"
      },
      {
        "title": "Forrest Gump",
        "director": "Robert Zemeckis",
        "year": 1994,
        "wiki": "https://fr.wikipedia.org/wiki/Forrest_Gump",
        "poster": "https://image.tmdb.org/t/p/w300/zi6RNYK1vXjIvpSBgjatXRcFYh2.jpg"
      },
      {
        "title": "Get Out",
        "director": "Jordan Peele",
        "year": 2017,
        "wiki": "https://fr.wikipedia.org/wiki/Get_Out",
        "poster": "https://image.tmdb.org/t/p/w300/8WzjAhgc4HvpN3Y6LLCc6AbpIhF.jpg"
      },
      {
        "title": "The Sixth Sense",
        "director": "M. Night Shyamalan",
        "year": 1999,
        "wiki": "https://fr.wikipedia.org/wiki/The_Sixth_Sense",
        "poster": "https://image.tmdb.org/t/p/w300/7s3ekiDpic8NxDjwdLdOYDIX8Pe.jpg",
        "seen": false
      }
    ]
  },
  {
    "section": "DAVID FINCHER",
    "color": "#4DD0E1",
    "films": [
      {
        "title": "Se7en",
        "director": "David Fincher",
        "year": 1995,
        "wiki": "https://fr.wikipedia.org/wiki/Seven_(film,_1995)",
        "poster": "https://image.tmdb.org/t/p/w300/upIOOLVeOoUkTM5fVWwXW2JmBrW.jpg",
        "seen": false
      },
      {
        "title": "Zodiac",
        "director": "David Fincher",
        "year": 2007,
        "wiki": "https://fr.wikipedia.org/wiki/Zodiac_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/ajHaO6hqFmvRNsUh3BIFwE5ghsI.jpg",
        "seen": false
      },
      {
        "title": "Gone Girl",
        "director": "David Fincher",
        "year": 2014,
        "wiki": "https://fr.wikipedia.org/wiki/Gone_Girl_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/7xkJ1ACu40BjzLHVPRILWjFvW7.jpg",
        "seen": false
      }
    ]
  },
  {
    "section": "CIN√âMA COR√âEN",
    "color": "#FF8A65",
    "films": [
      {
        "title": "Parasite",
        "director": "Bong Joon-ho",
        "year": 2019,
        "wiki": "https://fr.wikipedia.org/wiki/Parasite_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/rqpa5dO2zZIHqknnJr8LKwiYHy8.jpg",
        "seen": false
      },
      {
        "title": "Memories of Murder",
        "director": "Bong Joon-ho",
        "year": 2003,
        "wiki": "https://fr.wikipedia.org/wiki/Memories_of_Murder",
        "poster": "https://image.tmdb.org/t/p/w300/fz5NYI8PUmPplu3UA70AOqEDJL7.jpg",
        "seen": false
      },
      {
        "title": "Mother",
        "director": "Bong Joon-ho",
        "year": 2009,
        "wiki": "https://fr.wikipedia.org/wiki/Mother_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/mz5Rf5J56tvYmvVYFUPugjcQCV.jpg"
      },
      {
        "title": "I Saw the Devil",
        "director": "Kim Jee-woon",
        "year": 2010,
        "wiki": "https://fr.wikipedia.org/wiki/I_Saw_the_Devil",
        "poster": "https://image.tmdb.org/t/p/w300/i3x5Fck0BoAoLRbgPKzSESsrcOR.jpg"
      }
    ]
  },
  {
    "section": "CIN√âMA JAPONAIS (Samurai & Vagabond)",
    "color": "#FFD54F",
    "films": [
      {
        "title": "Samurai I: Musashi Miyamoto",
        "director": "Hiroshi Inagaki",
        "year": 1954,
        "wiki": "https://fr.wikipedia.org/wiki/Samurai_I_Musashi_Miyamoto",
        "poster": "https://image.tmdb.org/t/p/w300/ixqYPzlNA3QfKPZEjAVLHyvg3fG.jpg"
      },
      {
        "title": "Samurai II: Duel at Ichijoji Temple",
        "director": "Hiroshi Inagaki",
        "year": 1955,
        "wiki": "https://fr.wikipedia.org/wiki/Samurai_II_Duel_at_Ichijoji_Temple",
        "poster": "https://image.tmdb.org/t/p/w300/gR3qCQjt1pepUJSIDtL2DjKtbbO.jpg"
      },
      {
        "title": "Samurai III: Duel at Ganryu Island",
        "director": "Hiroshi Inagaki",
        "year": 1956,
        "wiki": "https://fr.wikipedia.org/wiki/Samurai_III_Duel_at_Ganryu_Island",
        "poster": "https://image.tmdb.org/t/p/w300/wzZcwGWfdykfIpBzGatXHNIiRZq.jpg"
      },
      {
        "title": "Seven Samurai",
        "director": "Akira Kurosawa",
        "year": 1954,
        "wiki": "https://fr.wikipedia.org/wiki/Seven_Samurai",
        "poster": "https://image.tmdb.org/t/p/w300/fYNfCxRiBHTo4WAb7OFyTzwdtmp.jpg"
      },
      {
        "title": "Yojimbo",
        "director": "Akira Kurosawa",
        "year": 1961,
        "wiki": "https://fr.wikipedia.org/wiki/Yojimbo",
        "poster": "https://image.tmdb.org/t/p/w300/eNdU4V5AqDidJllrNYeYafOFo45.jpg"
      },
      {
        "title": "Harakiri",
        "director": "Masaki Kobayashi",
        "year": 1962,
        "wiki": "https://fr.wikipedia.org/wiki/Harakiri_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/57sqCOLupae705vfs98YeSfKpqA.jpg"
      }
    ]
  },
  {
    "section": "AUTRES CLASSIQUES INDISPENSABLES",
    "color": "#81C784",
    "films": [
      {
        "title": "Apocalypse Now",
        "director": "Francis Ford Coppola",
        "year": 1979,
        "wiki": "https://fr.wikipedia.org/wiki/Apocalypse_Now",
        "poster": "https://image.tmdb.org/t/p/w300/scaiAT7I2KZ2GAeMvoU6Ro1515J.jpg"
      },
      {
        "title": "A Clockwork Orange",
        "director": "Stanley Kubrick",
        "year": 1971,
        "wiki": "https://fr.wikipedia.org/wiki/A_Clockwork_Orange",
        "poster": "https://image.tmdb.org/t/p/w300/n2oKNiEq9DZljqs6xsxs8hnsW9p.jpg"
      },
      {
        "title": "Chinatown",
        "director": "Roman Polanski",
        "year": 1974,
        "wiki": "https://fr.wikipedia.org/wiki/Chinatown_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/9chbM7rbh6o0Ok6v6mcT0a3GN9E.jpg"
      },
      {
        "title": "No Country for Old Men",
        "director": "Coen Brothers",
        "year": 2007,
        "wiki": "https://fr.wikipedia.org/wiki/No_Country_for_Old_Men",
        "poster": "https://image.tmdb.org/t/p/w300/6n6VaGkm4b5OeDNGuQ1L5IobQ27.jpg"
      },
      {
        "title": "Heat",
        "director": "Michael Mann",
        "year": 1995,
        "wiki": "https://fr.wikipedia.org/wiki/Heat_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/4miPIzrKBaSznoTBv1bS0sZwoMG.jpg"
      },
      {
        "title": "The Shining",
        "director": "Stanley Kubrick",
        "year": 1980,
        "wiki": "https://fr.wikipedia.org/wiki/The_Shining_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/cnniZQGtjK8kh2tsjih4GtkX6bl.jpg"
      },
      {
        "title": "Whiplash",
        "director": "Damien Chazelle",
        "year": 2014,
        "wiki": "https://fr.wikipedia.org/wiki/Whiplash_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/3XriEpTdnplQRzyphAC0cu3emns.jpg"
      },
      {
        "title": "The Social Network",
        "director": "David Fincher",
        "year": 2010,
        "wiki": "https://fr.wikipedia.org/wiki/The_Social_Network",
        "poster": "https://image.tmdb.org/t/p/w300/cvUfwhoAReL4e5eegFCHM73rIda.jpg"
      }
    ]
  },
  {
    "section": "DEUXI√àME LISTE ‚Äî Demandes sp√©cifiques",
    "color": "#BA68C8",
    "films": [
      {
        "title": "Dune (1984)",
        "director": "David Lynch",
        "year": 1984,
        "wiki": "https://fr.wikipedia.org/wiki/Dune_(film,_1984)",
        "poster": "https://image.tmdb.org/t/p/w300/kq0Umk5PVOx4HAcDcImjjFn79Jy.jpg"
      },
      {
        "title": "Midsommar",
        "director": "Ari Aster",
        "year": 2019,
        "wiki": "https://fr.wikipedia.org/wiki/Midsommar_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/17pvY55Zr60niVovNvgt72mwvES.jpg"
      },
      {
        "title": "Alien 2: Aliens",
        "director": "James Cameron",
        "year": 1986,
        "wiki": "https://fr.wikipedia.org/wiki/Aliens_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/uafMg29wVV4XvxPS59s8nBBbP4i.jpg"
      },
      {
        "title": "Alien 3",
        "director": "David Fincher",
        "year": 1992,
        "wiki": "https://fr.wikipedia.org/wiki/Alien_3",
        "poster": "https://image.tmdb.org/t/p/w300/qDdLfQJ4rR8zV5NLNVO6w2azp7n.jpg"
      },
      {
        "title": "Alien: Resurrection",
        "director": "Jean-Pierre Jeunet",
        "year": 1997,
        "wiki": "https://fr.wikipedia.org/wiki/Alien:_Resurrection",
        "poster": "https://image.tmdb.org/t/p/w300/ePPdAnGJk9mR1qNxHhGrIhLAo4Q.jpg"
      },
      {
        "title": "The Lighthouse",
        "director": "Robert Eggers",
        "year": 2019,
        "wiki": "https://fr.wikipedia.org/wiki/The_Lighthouse_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/8DTJq8btlJHVELjasGCa1mLMXUj.jpg"
      },
      {
        "title": "Platoon",
        "director": "Oliver Stone",
        "year": 1986,
        "wiki": "https://fr.wikipedia.org/wiki/Platoon_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/rehBWOx9AIkZRKVuiemWvAMH40.jpg"
      },
      {
        "title": "Logan",
        "director": "James Mangold",
        "year": 2017,
        "wiki": "https://fr.wikipedia.org/wiki/Logan_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/5HB2SsrYNARm4Kom7Amwyb93O4M.jpg"
      },
      {
        "title": "Snowpiercer",
        "director": "Bong Joon-ho",
        "year": 2013,
        "wiki": "https://fr.wikipedia.org/wiki/Snowpiercer",
        "poster": "https://image.tmdb.org/t/p/w300/vRr9z33hkI0Hp1gCCtV6s1jbf9.jpg"
      },
      {
        "title": "Blue Velvet",
        "director": "David Lynch",
        "year": 1986,
        "wiki": "https://fr.wikipedia.org/wiki/Blue_Velvet_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/zw0JOpVE5IFE8IfAm8zRX0AkB3O.jpg"
      },
      {
        "title": "The Thing",
        "director": "John Carpenter",
        "year": 1982,
        "wiki": "https://fr.wikipedia.org/wiki/The_Thing_(1982_film)",
        "poster": "https://image.tmdb.org/t/p/w300/gajOIkrWq10MDjpHwCmIt4Yip2z.jpg"
      },
      {
        "title": "Titanic",
        "director": "James Cameron",
        "year": 1997,
        "wiki": "https://fr.wikipedia.org/wiki/Titanic_(film)",
        "poster": "https://image.tmdb.org/t/p/w300/vpsvHLkoeKUjceIMeNSqCp3xEyY.jpg"
      },
      {
        "title": "La Montagne Sacr√©e",
        "director": "Alejandro Jodorowsky",
        "year": 1973,
        "wiki": "https://fr.wikipedia.org/wiki/La_montagne_sacree",
        "poster": "https://image.tmdb.org/t/p/w300/88f9KnD1ZNbPQJ4izmYsqWDatQB.jpg"
      },
      {
        "title": "Napol√©on (1927)",
        "director": "Abel Gance",
        "year": 1927,
        "wiki": "https://fr.wikipedia.org/wiki/Napol%C3%A9on_(film)",
        "seen": false
      },
      {
        "title": "Eyes Wide Shut",
        "director": "Stanley Kubrick",
        "year": 1999,
        "wiki": "https://fr.wikipedia.org/wiki/Eyes_Wide_Shut",
        "poster": "https://image.tmdb.org/t/p/w300/zrkNeLqUBm6bE2cqY5SBiM6LIf8.jpg"
      }
    ]
  },
  {
    "section": "STANLEY KUBRICK (essentiel)",
    "color": "#90CAF9",
    "films": [
      {
        "title": "Paths of Glory",
        "director": "Stanley Kubrick",
        "year": 1957,
        "wiki": "https://fr.wikipedia.org/wiki/Paths_of_Glory",
        "poster": "https://image.tmdb.org/t/p/w300/nLGw5N5VLmQR8bPbRMt772FWzCz.jpg"
      },
      {
        "title": "Dr. Strangelove",
        "director": "Stanley Kubrick",
        "year": 1964,
        "wiki": "https://fr.wikipedia.org/wiki/Dr._Strangelove",
        "poster": "https://image.tmdb.org/t/p/w300/vRTBTIj3LgsiTXMiJ32mfu7WY4T.jpg"
      },
      {
        "title": "2001: A Space Odyssey",
        "director": "Stanley Kubrick",
        "year": 1968,
        "wiki": "https://fr.wikipedia.org/wiki/2001:_A_Space_Odyssey",
        "poster": "https://image.tmdb.org/t/p/w300/uwd79G32FPIL5B9UkRgSZvS0gbe.jpg"
      },
      {
        "title": "Barry Lyndon",
        "director": "Stanley Kubrick",
        "year": 1975,
        "wiki": "https://fr.wikipedia.org/wiki/Barry_Lyndon",
        "poster": "https://image.tmdb.org/t/p/w300/prwtTDfRbwdNOzjURTabW3UYW0O.jpg"
      },
      {
        "title": "Full Metal Jacket",
        "director": "Stanley Kubrick",
        "year": 1987,
        "wiki": "https://fr.wikipedia.org/wiki/Full_Metal_Jacket",
        "poster": "https://image.tmdb.org/t/p/w300/cShwwkz4gBBIRj8yFy8TP2tEWZ4.jpg"
      }
    ]
  },
  {
    "section": "PLOT TWISTS & TURNMENTS",
    "color": "#FFCC80",
    "films": [
      {
        "title": "The Usual Suspects",
        "director": "Bryan Singer",
        "year": 1995,
        "wiki": "https://fr.wikipedia.org/wiki/The_Usual_Suspects",
        "poster": "https://image.tmdb.org/t/p/w300/h06jDZB4Y9YQJiSGTcUwbhuiUrB.jpg",
        "seen": false
      },
      {
        "title": "The Prestige",
        "director": "Christopher Nolan",
        "year": 2006,
        "wiki": "https://fr.wikipedia.org/wiki/The_Prestige",
        "poster": "https://image.tmdb.org/t/p/w300/37Fr7lY4QBHsuxlLJIfTNxW6nGW.jpg"
      },
      {
        "title": "Primal Fear",
        "director": "Gregory Hoblit",
        "year": 1996,
        "wiki": "https://fr.wikipedia.org/wiki/Primal_Fear",
        "poster": "https://image.tmdb.org/t/p/w300/f6tdI4rjobdtHJViPR2AeFFU8Ae.jpg"
      },
      {
        "title": "Psycho",
        "director": "Alfred Hitchcock",
        "year": 1960,
        "wiki": "https://fr.wikipedia.org/wiki/Psycho",
        "poster": "https://image.tmdb.org/t/p/w300/lzF8b44dAvXFagQnB1UZa2AF87q.jpg"
      },
      {
        "title": "Shutter Island",
        "director": "Martin Scorsese",
        "year": 2010,
        "wiki": "https://fr.wikipedia.org/wiki/Shutter_Island",
        "poster": "https://image.tmdb.org/t/p/w300/fQ0vGVTtxjCdAJnxwPZ88O3Wzrh.jpg"
      },
      {
        "title": "The Game",
        "director": "David Fincher",
        "year": 1997,
        "wiki": "https://fr.wikipedia.org/wiki/The_Game",
        "poster": "https://image.tmdb.org/t/p/w300/2sUcLRG3ZwE8JOrCzk3M6GyCsTx.jpg"
      }
    ]
  },
  {
    "section": "QUENTIN TARANTINO",
    "color": "#F06292",
    "films": [
      {
        "title": "Reservoir Dogs",
        "director": "Quentin Tarantino",
        "year": 1992,
        "wiki": "https://fr.wikipedia.org/wiki/Reservoir_Dogs",
        "poster": "https://image.tmdb.org/t/p/w300/p61wwD0jWfgbhg9Ja9uoDZdS8YE.jpg",
        "seen": false
      },
      {
        "title": "Kill Bill Vol. 2",
        "director": "Quentin Tarantino",
        "year": 2004,
        "wiki": "https://fr.wikipedia.org/wiki/Kill_Bill_Vol_2",
        "poster": "https://image.tmdb.org/t/p/w300/852ZvIARe3CISnX9t96unwSHyoL.jpg"
      },
      {
        "title": "Inglourious Basterds",
        "director": "Quentin Tarantino",
        "year": 2009,
        "wiki": "https://fr.wikipedia.org/wiki/Inglourious_Basterds",
        "poster": "https://image.tmdb.org/t/p/w300/lPKwFzX4TiWLA4Mo5Bnf8aIIrJm.jpg"
      },
      {
        "title": "Django Unchained",
        "director": "Quentin Tarantino",
        "year": 2012,
        "wiki": "https://fr.wikipedia.org/wiki/Django_Unchained",
        "poster": "https://image.tmdb.org/t/p/w300/vRXUnWrXUgXRoX0BaEcuNMfyeQt.jpg"
      },
      {
        "title": "The Hateful Eight",
        "director": "Quentin Tarantino",
        "year": 2015,
        "wiki": "https://fr.wikipedia.org/wiki/The_Hateful_Eight",
        "poster": "https://image.tmdb.org/t/p/w300/kV6ogsiIYzV2qZ43bLuDKuEAIR.jpg"
      },
      {
        "title": "Once Upon a Time‚Ä¶ in Hollywood",
        "director": "Quentin Tarantino",
        "year": 2019,
        "wiki": "https://fr.wikipedia.org/wiki/Once_Upon_a_Time%E2%80%A6_in_Hollywood",
        "poster": "https://image.tmdb.org/t/p/w300/gG5J1KW2Gzj0Sz7al1mGkhXLSoB.jpg"
      }
    ]
  },
  {
    "section": "BRIAN DE PALMA",
    "color": "#FFB74D",
    "films": [
      {
        "title": "Carrie",
        "director": "Brian De Palma",
        "year": 1976,
        "wiki": "https://fr.wikipedia.org/wiki/Carrie",
        "poster": "https://image.tmdb.org/t/p/w300/zaqBZyy5QeQ4YhiMurGb54TdvtU.jpg"
      },
      {
        "title": "Blow Out",
        "director": "Brian De Palma",
        "year": 1981,
        "wiki": "https://fr.wikipedia.org/wiki/Blow_Out",
        "poster": "https://image.tmdb.org/t/p/w300/zgyVsJNBdFbUgUUPTWiYBenBTKq.jpg"
      },
      {
        "title": "Scarface",
        "director": "Brian De Palma",
        "year": 1983,
        "wiki": "https://fr.wikipedia.org/wiki/Scarface",
        "poster": "https://image.tmdb.org/t/p/w300/eGctboDIdxBSxZIcF8iLc8gebd5.jpg",
        "seen": false
      },
      {
        "title": "The Untouchables",
        "director": "Brian De Palma",
        "year": 1987,
        "wiki": "https://fr.wikipedia.org/wiki/The_Untouchables",
        "poster": "https://image.tmdb.org/t/p/w300/xrdMy48NrJSJYRplKfuQT0sDfSI.jpg"
      }
    ]
  },
  {
    "section": "DAVID LYNCH (suite)",
    "color": "#A5D6A7",
    "films": [
      {
        "title": "Twin Peaks: Fire Walk With Me",
        "director": "David Lynch",
        "year": 1992,
        "wiki": "https://fr.wikipedia.org/wiki/Twin_Peaks_Fire_Walk_With_Me",
        "poster": "https://image.tmdb.org/t/p/w300/1uJjOuN7rA66V1Nc6BK4UWIxmIq.jpg"
      },
      {
        "title": "Lost Highway",
        "director": "David Lynch",
        "year": 1997,
        "wiki": "https://fr.wikipedia.org/wiki/Lost_Highway",
        "poster": "https://image.tmdb.org/t/p/w300/wsMW0D5AxoEiwl1e2HUAmmreUYn.jpg"
      },
      {
        "title": "Eraserhead",
        "director": "David Lynch",
        "year": 1977,
        "wiki": "https://fr.wikipedia.org/wiki/Eraserhead",
        "poster": "https://image.tmdb.org/t/p/w300/mxveW3mGVc0DzLdOmtkZsgd7c3B.jpg",
        "seen": false
      }
    ]
  },
  {
    "section": "GUILLERMO DEL TORO",
    "color": "#FF7043",
    "films": [
      {
        "title": "Pan's Labyrinth",
        "director": "Guillermo del Toro",
        "year": 2006,
        "wiki": "https://fr.wikipedia.org/wiki/Pan's_Labyrinth",
        "poster": "https://image.tmdb.org/t/p/w300/bpzGLrQC5nXvU3wrLtp1TDIKYX9.jpg"
      },
      {
        "title": "The Devil's Backbone",
        "director": "Guillermo del Toro",
        "year": 2001,
        "wiki": "https://fr.wikipedia.org/wiki/The_Devil's_Backbone",
        "poster": "https://image.tmdb.org/t/p/w300/lauLEU0X2g38Q4ZujzrFgF9jYww.jpg"
      },
      {
        "title": "Crimson Peak",
        "director": "Guillermo del Toro",
        "year": 2015,
        "wiki": "https://fr.wikipedia.org/wiki/Crimson_Peak",
        "poster": "https://image.tmdb.org/t/p/w300/sTfk9qcg4YE1Svl0854bxnSl3Mx.jpg"
      },
      {
        "title": "Nightmare Alley",
        "director": "Guillermo del Toro",
        "year": 2021,
        "wiki": "https://fr.wikipedia.org/wiki/Nightmare_Alley",
        "poster": "https://image.tmdb.org/t/p/w300/tbMON6DrX7sb8MCbsPwyQhQkmi3.jpg",
        "seen": false
      }
    ]
  },
  {
    "section": "ALEJANDRO G. I√ë√ÅRRITU",
    "color": "#64B5F6",
    "films": [
      {
        "title": "The Revenant",
        "director": "Alejandro Gonz√°lez I√±√°rritu",
        "year": 2015,
        "wiki": "https://fr.wikipedia.org/wiki/The_Revenant",
        "poster": "https://image.tmdb.org/t/p/w300/AsDto68FNWNXD15Ov0yMXASJiSB.jpg"
      },
      {
        "title": "Birdman",
        "director": "Alejandro Gonz√°lez I√±√°rritu",
        "year": 2014,
        "wiki": "https://fr.wikipedia.org/wiki/Birdman",
        "poster": "https://image.tmdb.org/t/p/w300/9n0u3Ee7OUjgeyF5kIwahxkf4xm.jpg"
      },
      {
        "title": "Babel",
        "director": "Alejandro Gonz√°lez I√±√°rritu",
        "year": 2006,
        "wiki": "https://fr.wikipedia.org/wiki/Babel",
        "poster": "https://image.tmdb.org/t/p/w300/c2wjEwMF4K81X24CsaBukVuHvBx.jpg"
      }
    ]
  },
  {
    "section": "PAUL THOMAS ANDERSON",
    "color": "#FFD54F",
    "films": [
      {
        "title": "There Will Be Blood",
        "director": "Paul Thomas Anderson",
        "year": 2007,
        "wiki": "https://fr.wikipedia.org/wiki/There_Will_Be_Blood",
        "poster": "https://image.tmdb.org/t/p/w300/cf4SpPyVRfE1lmlnVIXoii337s2.jpg"
      },
      {
        "title": "The Master",
        "director": "Paul Thomas Anderson",
        "year": 2012,
        "wiki": "https://fr.wikipedia.org/wiki/The_Master",
        "poster": "https://image.tmdb.org/t/p/w300/yC5ZLtkAIcivxXSOaY2uN4e7mih.jpg"
      },
      {
        "title": "Phantom Thread",
        "director": "Paul Thomas Anderson",
        "year": 2017,
        "wiki": "https://fr.wikipedia.org/wiki/Phantom_Thread",
        "poster": "https://image.tmdb.org/t/p/w300/ihUl0Gqb0BIeOrvYVmHol8CZLv0.jpg"
      },
      {
        "title": "Boogie Nights",
        "director": "Paul Thomas Anderson",
        "year": 1997,
        "wiki": "https://fr.wikipedia.org/wiki/Boogie_Nights",
        "poster": "https://image.tmdb.org/t/p/w300/qkgnK7CcefeqIThLyNjQasANGRt.jpg"
      },
      {
        "title": "Magnolia",
        "director": "Paul Thomas Anderson",
        "year": 1999,
        "wiki": "https://fr.wikipedia.org/wiki/Magnolia",
        "poster": "https://image.tmdb.org/t/p/w300/klhJK5KvHbWkGkO1x5bXzOfQAWp.jpg"
      }
    ]
  },
  {
    "section": "CHRISTOPHER NOLAN",
    "color": "#F48FB1",
    "films": [
      {
        "title": "Memento",
        "director": "Christopher Nolan",
        "year": 2000,
        "wiki": "https://fr.wikipedia.org/wiki/Memento",
        "poster": "https://image.tmdb.org/t/p/w300/dbkEpzotHJfotpSUSYI36aPC1WN.jpg"
      },
      {
        "title": "The Dark Knight",
        "director": "Christopher Nolan",
        "year": 2008,
        "wiki": "https://fr.wikipedia.org/wiki/The_Dark_Knight",
        "poster": "https://image.tmdb.org/t/p/w300/pyNXnq8QBWoK3b37RS6C3axwUOy.jpg"
      },
      {
        "title": "Insomnia",
        "director": "Christopher Nolan",
        "year": 2002,
        "wiki": "https://fr.wikipedia.org/wiki/Insomnia",
        "poster": "https://image.tmdb.org/t/p/w300/eJ49J6QXrTJryC61p43NTAULms.jpg"
      },
      {
        "title": "Dunkirk",
        "director": "Christopher Nolan",
        "year": 2017,
        "wiki": "https://fr.wikipedia.org/wiki/Dunkirk",
        "poster": "https://image.tmdb.org/t/p/w300/1VOKlC35yrwVKlfBSN52NY4zoF2.jpg"
      }
    ]
  },
  {
    "section": "DENIS VILLENEUVE",
    "color": "#4DD0E1",
    "films": [
      {
        "title": "Prisoners",
        "director": "Denis Villeneuve",
        "year": 2013,
        "wiki": "https://fr.wikipedia.org/wiki/Prisoners",
        "poster": "https://image.tmdb.org/t/p/w300/fUk1f0iOAezl5PZ7gQW6nrguOXk.jpg"
      },
      {
        "title": "Sicario",
        "director": "Denis Villeneuve",
        "year": 2015,
        "wiki": "https://fr.wikipedia.org/wiki/Sicario",
        "poster": "https://image.tmdb.org/t/p/w300/uYMvoFiatbs1G3ybN8Wd8VpJWxn.jpg"
      },
      {
        "title": "Enemy",
        "director": "Denis Villeneuve",
        "year": 2013,
        "wiki": "https://fr.wikipedia.org/wiki/Enemy",
        "poster": "https://image.tmdb.org/t/p/w300/zSgm3qveEDDDXRJp5QcHaIuXIqO.jpg"
      },
      {
        "title": "Arrival",
        "director": "Denis Villeneuve",
        "year": 2016,
        "wiki": "https://fr.wikipedia.org/wiki/Arrival",
        "poster": "https://image.tmdb.org/t/p/w300/mSgYBWMybY9Ug4ZnCGsttPIjUx7.jpg"
      }
    ]
  },
  {
    "section": "MARTIN SCORSESE",
    "color": "#FF8A65",
    "films": [
      {
        "title": "Raging Bull",
        "director": "Martin Scorsese",
        "year": 1980,
        "wiki": "https://fr.wikipedia.org/wiki/Raging_Bull",
        "poster": "https://image.tmdb.org/t/p/w300/pbJqnZccb9g6DCrX40Y4eUzRbap.jpg"
      },
      {
        "title": "The Departed",
        "director": "Martin Scorsese",
        "year": 2006,
        "wiki": "https://fr.wikipedia.org/wiki/The_Departed",
        "poster": "https://image.tmdb.org/t/p/w300/xHeuF5zzlx1YxkULiz0mx1TMBJ7.jpg"
      },
      {
        "title": "Casino",
        "director": "Martin Scorsese",
        "year": 1995,
        "wiki": "https://fr.wikipedia.org/wiki/Casino",
        "poster": "https://image.tmdb.org/t/p/w300/4a0I37pYcdFY6HeutalHQTGs0sl.jpg"
      }
    ]
  },
  {
    "section": "JACKIE CHAN",
    "color": "#D84315",
    "films": [
      {
        "title": "Police Story",
        "director": "Jackie Chan",
        "year": 1985,
        "wiki": "https://fr.wikipedia.org/wiki/Police_Story",
        "poster": "https://image.tmdb.org/t/p/w300/zZYk5lyQXPEcuvJIMfXZp6lvYb5.jpg"
      },
      {
        "title": "Drunken Master II",
        "director": "Jackie Chan",
        "year": 1994,
        "wiki": "https://fr.wikipedia.org/wiki/Drunken_Master_II",
        "poster": "https://image.tmdb.org/t/p/w300/9MSj0X0LVgBacipLKdLO7JpFQdS.jpg"
      },
      {
        "title": "Project A",
        "director": "Jackie Chan",
        "year": 1983,
        "wiki": "https://fr.wikipedia.org/wiki/Project_A",
        "poster": "https://image.tmdb.org/t/p/w300/wOvYZ74VpU0Gx4owJ2oS9ky95ac.jpg"
      }
    ]
  },
  {
    "section": "FILMS DE GUERRE",
    "color": "#66BB6A",
    "films": [
      {
        "title": "Saving Private Ryan",
        "director": "Steven Spielberg",
        "year": 1998,
        "wiki": "https://fr.wikipedia.org/wiki/Saving_Private_Ryan",
        "poster": "https://image.tmdb.org/t/p/w300/mlSsQWIQV0NKIqqRQRI0yi9gqk8.jpg"
      },
      {
        "title": "Full Metal Jacket",
        "director": "Stanley Kubrick",
        "year": 1987,
        "wiki": "https://fr.wikipedia.org/wiki/Full_Metal_Jacket",
        "poster": "https://image.tmdb.org/t/p/w300/cShwwkz4gBBIRj8yFy8TP2tEWZ4.jpg"
      },
      {
        "title": "The Thin Red Line",
        "director": "Terrence Malick",
        "year": 1998,
        "wiki": "https://fr.wikipedia.org/wiki/The_Thin_Red_Line",
        "poster": "https://image.tmdb.org/t/p/w300/lI1idojUCegX0e6CPMooNugb7O5.jpg"
      },
      {
        "title": "Black Hawk Down",
        "director": "Ridley Scott",
        "year": 2001,
        "wiki": "https://fr.wikipedia.org/wiki/Black_Hawk_Down",
        "poster": "https://image.tmdb.org/t/p/w300/8PbLgvdfcdBad3sie9cfIBHq2Xz.jpg"
      }
    ]
  },
  {
    "section": "N√âOR√âALISME & POST-GUERRE",
    "color": "#64B5F6",
    "films": [
      {
        "title": "The Marriage of Maria Braun",
        "director": "Rainer Werner Fassbinder",
        "year": 1979,
        "wiki": "https://fr.wikipedia.org/wiki/The_Marriage_of_Maria_Braun",
        "poster": "https://image.tmdb.org/t/p/w300/l3Jgm9Qi1t3fnRhD58sw613rahN.jpg"
      },
      {
        "title": "Wings of Desire",
        "director": "Wim Wenders",
        "year": 1987,
        "wiki": "https://fr.wikipedia.org/wiki/Wings_of_Desire",
        "poster": "https://image.tmdb.org/t/p/w300/1rtftILuYomSueOl5Z6fRM3IbOx.jpg"
      },
      {
        "title": "Aguirre, the Wrath of God",
        "director": "Werner Herzog",
        "year": 1972,
        "wiki": "https://fr.wikipedia.org/wiki/Aguirre_the_Wrath_of_God",
        "poster": "https://image.tmdb.org/t/p/w300/oq0TfwtkuMocFuwoHyEILgnbNZM.jpg"
      },
      {
        "title": "Fitzcarraldo",
        "director": "Werner Herzog",
        "year": 1982,
        "wiki": "https://fr.wikipedia.org/wiki/Fitzcarraldo",
        "poster": "https://image.tmdb.org/t/p/w300/ffWXGB8ZMdL5xgZAELR2M1vD1an.jpg",
        "seen": false
      }
    ]
  },
  {
    "section": "BLOCKBUSTERS & SAGAS",
    "color": "#FF7043",
    "films": [
      {
        "title": "Terminator",
        "director": "James Cameron",
        "year": 1984,
        "wiki": "https://fr.wikipedia.org/wiki/Terminator",
        "poster": "https://image.tmdb.org/t/p/w300/oShNrYScpLBi4pyOjytPy9BerRr.jpg"
      },
      {
        "title": "Terminator 2: Judgment Day",
        "director": "James Cameron",
        "year": 1991,
        "wiki": "https://fr.wikipedia.org/wiki/Terminator_2_Judgment_Day",
        "poster": "https://image.tmdb.org/t/p/w300/mRtFOHF93zW4kTp4JOYrH71vxBh.jpg"
      },
      {
        "title": "Indiana Jones: Raiders of the Lost Ark",
        "director": "Steven Spielberg",
        "year": 1981,
        "wiki": "https://fr.wikipedia.org/wiki/Indiana_Jones_Raiders_of_the_Lost_Ark",
        "poster": "https://image.tmdb.org/t/p/w300/nTsllJhHBDZndFudSB2RgeHuQAt.jpg"
      },
      {
        "title": "Indiana Jones and the Last Crusade",
        "director": "Steven Spielberg",
        "year": 1989,
        "wiki": "https://fr.wikipedia.org/wiki/Indiana_Jones_and_the_Last_Crusade",
        "poster": "https://image.tmdb.org/t/p/w300/kD1y7bgbkXvN3RkYogFMlyQR6Ci.jpg"
      },
      {
        "title": "RoboCop",
        "director": "Paul Verhoeven",
        "year": 1987,
        "wiki": "https://fr.wikipedia.org/wiki/RoboCop",
        "poster": "https://image.tmdb.org/t/p/w300/8LMpX3an8eHTfU1bNwXeGVkBVrZ.jpg"
      }
    ]
  },
  {
    "section": "CINEMA COR√âEN (suite)",
    "color": "#FF8A65",
    "films": [
      {
        "title": "The Wailing",
        "director": "Na Hong-jin",
        "year": 2016,
        "wiki": "https://fr.wikipedia.org/wiki/The_Wailing",
        "poster": "https://image.tmdb.org/t/p/w300/qmWlSdvzGp4tyJpI76JrEEmU0F2.jpg"
      },
      {
        "title": "Burning",
        "director": "Lee Chang-dong",
        "year": 2018,
        "wiki": "https://fr.wikipedia.org/wiki/Burning",
        "poster": "https://image.tmdb.org/t/p/w300/pdEgV6PckeiVcnComUw8bOirrpC.jpg"
      },
      {
        "title": "A Bittersweet Life",
        "director": "Kim Jee-woon",
        "year": 2005,
        "wiki": "https://fr.wikipedia.org/wiki/A_Bittersweet_Life",
        "poster": "https://image.tmdb.org/t/p/w300/7l3PEvgelhqGSvvnnO9kwCOh5pM.jpg"
      }
    ]
  },
  {
    "section": "EXPERIENCES / ART & ESSAI",
    "color": "#BA68C8",
    "films": [
      {
        "title": "Stalker",
        "director": "Andre√Ø Tarkovski",
        "year": 1979,
        "wiki": "https://fr.wikipedia.org/wiki/Stalker",
        "poster": "https://image.tmdb.org/t/p/w300/vBmOOIIfL9V8VpvS6STSJZ68Ni8.jpg"
      },
      {
        "title": "Persona",
        "director": "Ingmar Bergman",
        "year": 1966,
        "wiki": "https://fr.wikipedia.org/wiki/Persona",
        "poster": "https://image.tmdb.org/t/p/w300/uUqOvN4t5FSHpheO0rNoTF79hBn.jpg"
      },
      {
        "title": "Enter the Void",
        "director": "Gaspar No√©",
        "year": 2009,
        "wiki": "https://fr.wikipedia.org/wiki/Enter_the_Void",
        "poster": "https://image.tmdb.org/t/p/w300/skICGEadyeI3qiXbA1Pjx6sOoWU.jpg"
      },
      {
        "title": "The Mirror",
        "director": "Andre√Ø Tarkovski",
        "year": 1975,
        "wiki": "https://fr.wikipedia.org/wiki/The_Mirror",
        "poster": "https://image.tmdb.org/t/p/w300/3KCrrPy4ogGrNDhGIz0TbY1NhFb.jpg",
        "seen": false
      }
    ]
  }
];

let filmsData = [];
try{
  const s = localStorage.getItem(STORAGE_KEY);
  if(s){ const p = JSON.parse(s); if(Array.isArray(p) && p.length) filmsData = p; else filmsData = initialSections; } else filmsData = initialSections;
}catch(e){ filmsData = initialSections; }

/* Refs */
const allSectionsEl = qs('#all-sections');
const seenEl = qs('#seen-list');
const manageList = qs('#manage-list');
const addSectionInput = qs('#new-section');
const exportBtn = qs('#exportBtn');
const importFile = qs('#importFile');
const floatingText = qs('#floatingText');
const floatingAddBtn = qs('#floatingAddBtn');
const headerAddBtn = qs('#header-add-btn');
const floatingCounterEl = qs('#floatingCounter');

/* TMDB refs */
const tmdbSourceEl = qs('#tmdb-source');
const tmdbGenreEl = qs('#tmdb-genre');
const tmdbDateEl = qs('#tmdb-date');
const tmdbSearchEl = qs('#tmdb-search');
const tmdbFilterBtn = qs('#tmdb-filter');
const tmdbRefreshBtn = qs('#tmdb-refresh');
const tmdbListEl = qs('#tmdb-list');
const carouselTrack = qs('#carousel-track');
const carouselBg = qs('#carousel-bg');
const tmdbAllContainer = qs('#tmdb-all-container');
const tmdbWatchedContainer = qs('#tmdb-watched-container');
const tmdbSubAllBtn = qs('#tmdb-sub-all');
const tmdbSubWatchedBtn = qs('#tmdb-sub-watched');

let allSearchQuery = '';
let tmdbMovies = [], tmdbDisplayed = [], currentTmdbSource = 'all', carouselRAF = null;

/* Save / export / import */
function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(filmsData)); updateCounters(); }

exportBtn.addEventListener('click', ()=>{ 
  // Collect TMDB films from localStorage
  const tmdbFilms = [];
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k && k.startsWith('tmdb_')){
      try{
        const v = JSON.parse(localStorage.getItem(k));
        if(v) {
          // Add the ID from the key if not already present
          if(!v.id) v.id = k.replace('tmdb_', '');
          tmdbFilms.push(v);
        }
      }catch(e){}
    }
  }
  
  // Create export object with both section films and TMDB films
  const exportData = {
    sections: filmsData,
    tmdbFilms: tmdbFilms
  };
  
  const blob=new Blob([JSON.stringify(exportData,null,2)],{type:'application/json'}); 
  const a=document.createElement('a'); 
  a.href=URL.createObjectURL(blob); 
  a.download='marathon_export.json'; 
  a.click(); 
});

importFile.addEventListener('change', (ev)=>{ 
  const f = ev.target.files && ev.target.files[0]; 
  if(!f) return; 
  const r=new FileReader(); 
  r.onload = ()=>{ 
    try{ 
      const j = JSON.parse(r.result); 
      
      // Handle new format (with sections and tmdbFilms)
      if(j.sections && Array.isArray(j.sections)){
        filmsData = j.sections;
        
        // Clear existing TMDB entries
        const keysToRemove = [];
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if(k && k.startsWith('tmdb_')) keysToRemove.push(k);
        }
        keysToRemove.forEach(k => localStorage.removeItem(k));
        
        // Restore TMDB films
        if(j.tmdbFilms && Array.isArray(j.tmdbFilms)){
          j.tmdbFilms.forEach(film => {
            if(film.id || film.title){
              const key = 'tmdb_' + (film.id || btoa(film.title).substring(0,20));
              localStorage.setItem(key, JSON.stringify(film));
            }
          });
        }
        
        saveData(); 
        renderAll(); 
        renderSeen(); 
        renderManage(); 
        populateSectionSelects(); 
        alert('Import OK'); 
      } 
      // Handle legacy format (just array of sections)
      else if(Array.isArray(j)){ 
        filmsData=j; 
        saveData(); 
        renderAll(); 
        renderSeen(); 
        renderManage(); 
        populateSectionSelects(); 
        alert('Import OK (format ancien - films TMDB non inclus)'); 
      } 
      else {
        alert('Format JSON non reconnu'); 
      }
    } catch(e){ 
      alert('Erreur JSON'); 
    } 
    ev.target.value=''; 
  }; 
  r.readAsText(f); 
});

/* ========================= COUNTER (fixed + animation) ========================= */
/* previous values to detect changes */
let _prevTotal = null;
let _prevSeen = null;

function updateCounters(){
  // count local films
  const totalLocal = filmsData.reduce((a,s)=> a + (s.films? s.films.length : 0), 0);
  const seenLocal = filmsData.reduce((a,s)=> a + (s.films? s.films.filter(f=>f.seen).length : 0), 0);

  // count TMDB items stored in localStorage (keys starting with 'tmdb_')
  let tmdbTotal = 0;
  let tmdbSeen = 0;
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k && typeof k === 'string' && k.startsWith('tmdb_')){
      tmdbTotal++;
      try{
        const v = JSON.parse(localStorage.getItem(k));
        if(v && v.seen) tmdbSeen++;
      }catch(e){
        // if parse error, assume seen (legacy)
        tmdbSeen++;
      }
    }
  }

  const total = totalLocal + tmdbTotal;
  const seen = seenLocal + tmdbSeen;

  // update the visible text
  floatingText.textContent = `Vus : ${seen} / ${total}`;

  // trigger animation if changed
  if(_prevTotal === null) { _prevTotal = total; _prevSeen = seen; return; }
  if(_prevTotal !== total || _prevSeen !== seen){
    // add pulse class
    try{
      floatingCounterEl.classList.remove('counter-pulse');
      // force reflow to restart animation
      void floatingCounterEl.offsetWidth;
      floatingCounterEl.classList.add('counter-pulse');
      // remove after animation duration
      setTimeout(()=>{ floatingCounterEl.classList.remove('counter-pulse'); }, 320);
    }catch(e){}
    _prevTotal = total;
    _prevSeen = seen;
  }

  // update watched UI (TMDB watched subtab)
  updateTmdbWatchedUI();
}

/* Make floating counter clickable: open "Films vus" */
if(floatingCounterEl){
  floatingCounterEl.addEventListener('click', (e)=>{
    // If click on the inner "Ajouter" button, ignore (it's a separate action)
    const tgt = e.target;
    if(tgt && (tgt.id === 'floatingAddBtn' || tgt.closest && tgt.closest('#floatingAddBtn'))) return;
    
    // switch tab buttons
    qsa('.tab-btn').forEach(b=>b.classList.remove('active'));
    const seenBtn = document.querySelector('.tab-btn[data-tab="seen"]');
    if(seenBtn) seenBtn.classList.add('active');
    
    // Fade out current tab, then fade in seen tab
    const currentTab = document.querySelector('[data-tabcontent]:not([style*="display: none"])');
    const seenSection = document.getElementById('seen');
    
    if(currentTab && currentTab !== seenSection && seenSection){
      currentTab.style.animation = 'fadeOut 0.2s ease-out';
      setTimeout(() => {
        qsa('[data-tabcontent]').forEach(c=>c.style.display='none');
        seenSection.style.display = 'block';
        seenSection.style.animation = 'fadeIn 0.3s ease-in forwards';
        seenSection.scrollIntoView({behavior:'smooth', block:'start'});
      }, 200);
    } else if(seenSection) {
      qsa('[data-tabcontent]').forEach(c=>c.style.display='none');
      seenSection.style.display = 'block';
      seenSection.style.animation = 'fadeIn 0.3s ease-in forwards';
      seenSection.scrollIntoView({behavior:'smooth', block:'start'});
    }
  });
}

/* initial prev values to ensure first update shows correctly */
_prevTotal = null; _prevSeen = null;

/* ============================================================================== */

/* Render ALL */
function renderAll(){
  allSectionsEl.innerHTML = '';
  const q = (allSearchQuery||'').toLowerCase().trim();
  let globalIndex = 1;
  filmsData.forEach((sec, si) => {
    let filmsToShow = sec.films || [];
    if(q){
      filmsToShow = filmsToShow.filter(f =>
        (f.title||'').toLowerCase().includes(q) ||
        (f.director||'').toLowerCase().includes(q) ||
        (f.year||'').toString().includes(q) ||
        (sec.section||'').toLowerCase().includes(q)
      );
    }
    if(q && filmsToShow.length === 0) return;

    const wrap = el('div','section');
    wrap.style.borderColor = sec.color || '#666';
    const head = el('div','section-head');
    const left = el('div','section-info');
    const h = el('div','section-title', sec.section);
    h.style.color = sec.color || '#fff';
    const info = el('div','section-meta', `Films : ${sec.films.length} ‚Äî Vus : ${ (sec.films||[]).filter(f=>f.seen).length }`);
    left.appendChild(h); left.appendChild(info);

    const right = el('div');
    // ADD button already present ‚Äî keep at same spot
    const addBtn = el('button','action-btn','Ajouter un film'); addBtn.style.marginLeft='8px'; addBtn.style.color='#fff';
    addBtn.addEventListener('click', ()=> openInlineAdd(wrap, si));
    const renameBtn = el('button','action-btn','Renommer'); renameBtn.style.marginLeft='8px'; renameBtn.style.color='#fff';
    renameBtn.addEventListener('click', ()=>{ const n = prompt('Nouveau nom', sec.section); if(n){ filmsData[si].section = n.trim(); saveData(); renderAll(); renderManage(); }});
    const delBtn = el('button','action-delete','Supprimer'); delBtn.style.marginLeft='6px';
    delBtn.addEventListener('click', ()=>{ if(confirm('Supprimer section et ses films ?')){ filmsData.splice(si,1); saveData(); renderAll(); renderManage(); populateSectionSelects(); }});
    right.appendChild(addBtn); right.appendChild(renameBtn); right.appendChild(delBtn);

    head.appendChild(left); head.appendChild(right);
    wrap.appendChild(head);

    // Create a map from film to index for O(1) lookup
    const filmToIndex = new Map();
    sec.films.forEach((film, idx) => filmToIndex.set(film, idx));
    
    filmsToShow.forEach((f, localIndex) => {
      // Find the actual index in the full films array
      const actualFilmIndex = filmToIndex.get(f);
      if (actualFilmIndex === undefined) return; // Safety check
      
      const row = el('div','film');
      const num = el('div','num', globalIndex);
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!f.seen;
      cb.style.marginLeft='0';
      cb.addEventListener('change', () => {
        filmsData[si].films[actualFilmIndex].seen = cb.checked;
        // Add timestamp when marking as seen
        if (cb.checked) {
          filmsData[si].films[actualFilmIndex].seenDate = Date.now();
        } else {
          // Remove seenDate when unchecking
          delete filmsData[si].films[actualFilmIndex].seenDate;
        }
        saveData();
        row.classList.remove('checked-pop');
        void row.offsetWidth;
        row.classList.add('checked-pop');
        setTimeout(()=>row.classList.remove('checked-pop'), 300);
        renderSeen();
        info.textContent = `Films : ${sec.films.length} ‚Äî Vus : ${ (sec.films||[]).filter(x=>x.seen).length }`;
      });

      const poster = el('img'); poster.style.width='64px';
      if(f.poster){ poster.src = f.poster; } else poster.style.display='none';
      if(!f.poster && f.title){ fetchPosterForStatic(f.title, f.year).then(url=>{ if(url){ filmsData[si].films[actualFilmIndex].poster = url; saveData(); renderAll(); } }).catch(()=>{}); }

      const txt = el('div');
      const title = el('div','title', f.title + (f.year? ' ('+f.year+')':'' ));
      const meta = el('div','meta', f.director || '');
      txt.appendChild(title); txt.appendChild(meta);

      const actions = el('div','actions');
      if(f.wiki){ const a = el('a','wiki-link','Wiki'); a.href = f.wiki; a.target='_blank'; actions.appendChild(a); }
      // Watch button
      const watchBtn = el('span','watch-link','‚ñ∂ Watch'); watchBtn.title='Regarder sur watchseries.bar';
      watchBtn.addEventListener('click', ()=> openWatchseries(f.title, f.tmdbId, f.year));
      actions.appendChild(watchBtn);
      const editBtn = el('button','action-btn','‚úèÔ∏è'); editBtn.title='Modifier';
      editBtn.addEventListener('click', ()=> editFilm(si, actualFilmIndex));
      const delBtn2 = el('button','action-delete','üóëÔ∏è'); delBtn2.title='Supprimer';
      delBtn2.addEventListener('click', ()=>{ if(confirm('Supprimer ce film ?')){ filmsData[si].films.splice(actualFilmIndex,1); saveData(); renderAll(); renderManage(); }});
      actions.appendChild(editBtn); actions.appendChild(delBtn2);

      row.appendChild(num);
      // Put checkbox immediately after number (no extra gap)
      row.appendChild(cb);
      row.appendChild(poster); row.appendChild(txt); row.appendChild(actions);
      wrap.appendChild(row);
      globalIndex++;
    });

    allSectionsEl.appendChild(wrap);
  });

  const bottom = el('div','section');
  const bh = el('h3', null, 'Cr√©er une section rapidement'); bottom.appendChild(bh);
  const bf = el('div','add-form');
  const bi = document.createElement('input'); bi.placeholder='Nom de la section';
  const bb = el('button','button','Cr√©er');
  bb.addEventListener('click', ()=>{ const n = bi.value.trim(); if(!n){ alert('Nom requis'); return; } filmsData.push({ section: n, color: randomColor(), films: [] }); saveData(); renderAll(); renderManage(); populateSectionSelects(); bi.value=''; });
  bf.appendChild(bi); bf.appendChild(bb); bottom.appendChild(bf);
  allSectionsEl.appendChild(bottom);

  populateSectionSelects();
}

/* Inline add inside a section (reused) */
function openInlineAdd(wrap, si){
  // if there is already an inline form, toggle it
  const existing = wrap.querySelector('.inline-form');
  if(existing){ existing.remove(); return; }
  const form = el('div','inline-form');
  const t = document.createElement('input'); t.placeholder='Titre';
  const d = document.createElement('input'); d.placeholder='R√©alisateur';
  const y = document.createElement('input'); y.placeholder='Ann√©e';
  const w = document.createElement('input'); w.placeholder='Wiki (optionnel)';
  const ok = el('button','button','Ajouter');
  ok.addEventListener('click', async ()=>{
    const newFilm = { title: t.value.trim(), director: d.value.trim(), year: y.value.trim(), wiki: w.value.trim() || autoWiki(t.value.trim()), poster:null, tmdbId:null, seen:false };
    if(!newFilm.title){ alert('Titre requis'); return; }
    filmsData[si].films.push(newFilm);
    saveData();
    // Fetch poster and TMDB ID
    fetchTMDBDetailsByTitle(newFilm.title).then(details=>{ 
      if(details){ 
        if(details.poster) newFilm.poster = details.poster;
        if(details.tmdbId) newFilm.tmdbId = details.tmdbId;
        saveData(); renderAll(); 
      } 
    }).catch(()=>{});
    renderAll(); renderManage(); renderSeen();
    form.remove();
  });
  const cancel = el('button','action-btn','Annuler');
  cancel.addEventListener('click', ()=> form.remove());
  form.appendChild(t); form.appendChild(d); form.appendChild(y); form.appendChild(w); form.appendChild(ok); form.appendChild(cancel);
  wrap.appendChild(form);

  // Autofill in inline form: debounce 300ms and OVERWRITE fields (per your request)
  let inlineTimer = null;
  t.addEventListener('input', ()=> {
    clearTimeout(inlineTimer);
    inlineTimer = setTimeout(async ()=>{
      const q = t.value.trim();
      if(!q) return;
      const details = await fetchTMDBDetailsByTitle(q);
      if(details){
        // overwrite director/year/wiki as user requested
        d.value = details.director || '';
        y.value = details.year || '';
        w.value = details.wiki || (details.title ? autoWiki(details.title) : '');
      }
    }, 300);
  });
}

/* Render Seen */
function renderSeen(){
  const list = [];
  filmsData.forEach(sec => { (sec.films||[]).forEach(f=>{ if(f.seen) list.push({ title: f.title, year: f.year, section: sec.section, poster: f.poster, director: f.director, source: 'section', rating: f.rating || 0, filmObj: f, seenDate: f.seenDate || 0}); }); });
  // TMDB seen
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k && k.startsWith('tmdb_')){
      try{
        const v = JSON.parse(localStorage.getItem(k));
        if(v) list.push({ title: v.title || ('#'+k.replace('tmdb_','')), year: v.release_date ? v.release_date.split('-')[0] : '', section: 'TMDB', poster: v.poster || null, director: v.director || '', source: 'tmdb', id: k.replace('tmdb_',''), rating: v.rating || 0, tmdbKey: k, seenDate: v.seenDate || 0 });
      }catch(e){}
    }
  }
  
  // Sort by seenDate ascending (oldest first = lowest number)
  list.sort((a, b) => (a.seenDate || 0) - (b.seenDate || 0));

  seenEl.innerHTML = '';
  if(list.length === 0){ seenEl.textContent = '(Aucun film coch√©)'; return; }
  list.forEach((it,i) => {
    const row = el('div','film');
    const n = el('div','num', i+1);
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = true;
    cb.style.marginLeft='0';
    cb.addEventListener('change', ()=>{
      // If TMDB: remove localStorage entry (Option A). If section source: set seen=false in filmsData.
      if(it.source === 'tmdb'){
        try{ localStorage.removeItem('tmdb_'+it.id); }catch(e){}
      } else {
        // find and unmark in filmsData
        for(let si=0; si<filmsData.length; si++){
          const fidx = filmsData[si].films.findIndex(ff=> ff.title===it.title && (ff.year||'')=== (it.year||''));
          if(fidx !== -1){ 
            filmsData[si].films[fidx].seen = false; 
            delete filmsData[si].films[fidx].seenDate;
            break; 
          }
        }
        saveData();
      }
      updateCounters(); renderSeen(); renderAll(); updateTmdbWatchedUI();
    });
    const img = el('img'); if(it.poster){ img.src = it.poster; img.style.width='48px'; } else img.style.display='none';
    const info = el('div');
    const titleRow = el('div'); titleRow.style.display='flex'; titleRow.style.alignItems='center';
    const t = el('div','title', it.title + (it.year? ' ('+it.year+')':'' ));
    
    // Add star rating next to title
    const starRating = createStarRating(it.rating || 0, (newRating) => {
      // Save the new rating
      if(it.source === 'tmdb'){
        try{
          const v = JSON.parse(localStorage.getItem(it.tmdbKey) || '{}');
          v.rating = newRating;
          localStorage.setItem(it.tmdbKey, JSON.stringify(v));
        }catch(e){}
      } else {
        // Update in filmsData
        if(it.filmObj){
          it.filmObj.rating = newRating;
          saveData();
        }
      }
    });
    
    titleRow.appendChild(t);
    titleRow.appendChild(starRating);
    
    const s = el('div','small', it.section || '');
    if(it.director) { const d = el('div','meta', it.director); info.appendChild(d); }
    info.appendChild(titleRow); info.appendChild(s);
    row.appendChild(n); row.appendChild(cb); row.appendChild(img); row.appendChild(info);
    seenEl.appendChild(row);
  });
}

/* Render manage - Redesigned */
function renderManage(){
  manageList.innerHTML = '';
  
  // Update stats
  const statsEl = qs('#manage-stats');
  if(statsEl){
    const totalSections = filmsData.length;
    const totalFilms = filmsData.reduce((sum, s) => sum + s.films.length, 0);
    const totalWatched = filmsData.reduce((sum, s) => sum + s.films.filter(f => f.seen).length, 0);
    statsEl.innerHTML = `
      <div class="stat">üìÅ <span class="stat-value">${totalSections}</span> sections</div>
      <div class="stat">üé¨ <span class="stat-value">${totalFilms}</span> films</div>
      <div class="stat">‚úÖ <span class="stat-value">${totalWatched}</span> vus</div>
    `;
  }
  
  if(filmsData.length === 0){
    manageList.innerHTML = `
      <div class="manage-empty">
        <div class="manage-empty-icon">üìÅ</div>
        <div>Aucune section cr√©√©e</div>
        <div style="font-size:13px;margin-top:8px">Cr√©ez votre premi√®re section ci-dessus</div>
      </div>
    `;
    return;
  }
  
  filmsData.forEach((s, i) => {
    const card = el('div', 'manage-section-card');
    card.dataset.index = i;
    
    const watchedCount = s.films.filter(f => f.seen).length;
    const icons = ['üé¨', 'üé≠', 'üé™', 'üéØ', 'üé®', 'üé∏', 'üéπ', 'üé∫', 'üéª', 'üéº'];
    const icon = icons[i % icons.length];
    
    // Card header
    const header = el('div', 'manage-card-header');
    header.innerHTML = `
      <div class="manage-card-icon">${icon}</div>
      <div class="manage-card-info">
        <div class="manage-card-title">${s.section}</div>
        <div class="manage-card-meta">
          <span>üé¨ ${s.films.length} films</span>
          <span>‚úÖ ${watchedCount} vus</span>
        </div>
      </div>
    `;
    
    // Actions
    const actions = el('div', 'manage-card-actions');
    
    const renameBtn = el('button', 'manage-card-btn', '‚úèÔ∏è Renommer');
    renameBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const n = prompt('Nouveau nom de la section:', s.section);
      if(n && n.trim()){ 
        filmsData[i].section = n.trim(); 
        saveData(); 
        renderManage(); 
        renderAll(); 
        populateSectionSelects();
      }
    });
    
    const deleteBtn = el('button', 'manage-card-btn danger', 'üóëÔ∏è Supprimer');
    deleteBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if(confirm(`Supprimer la section "${s.section}" et ses ${s.films.length} films ?`)){ 
        filmsData.splice(i, 1); 
        saveData(); 
        renderManage(); 
        renderAll(); 
        populateSectionSelects(); 
      }
    });
    
    const expandBtn = el('button', 'manage-card-expand', '‚ñº');
    expandBtn.title = 'Voir les films';
    
    actions.appendChild(renameBtn);
    actions.appendChild(deleteBtn);
    actions.appendChild(expandBtn);
    header.appendChild(actions);
    
    // Films list (expandable)
    const filmsList = el('div', 'manage-card-films');
    
    if(s.films.length === 0){
      filmsList.innerHTML = '<div style="padding:16px;text-align:center;color:var(--muted);font-size:13px">Aucun film dans cette section</div>';
    } else {
      s.films.forEach((f, fi) => {
        const filmItem = el('div', 'manage-film-item');
        
        const poster = el('img', 'manage-film-poster');
        poster.src = f.poster || '';
        poster.alt = f.title;
        poster.onerror = function(){ this.style.display='none'; };
        
        const info = el('div', 'manage-film-info');
        info.innerHTML = `
          <div class="manage-film-title">${f.title}${f.year ? ` (${f.year})` : ''}</div>
          <div class="manage-film-meta">${f.director || 'R√©alisateur inconnu'}${f.seen ? ' ‚Ä¢ ‚úÖ Vu' : ''}</div>
        `;
        
        const filmActions = el('div', 'manage-film-actions');
        
        const editBtn = el('button', 'manage-film-btn', '‚úèÔ∏è');
        editBtn.title = 'Modifier';
        editBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          editFilm(i, fi);
        });
        
        const delBtn = el('button', 'manage-film-btn', 'üóëÔ∏è');
        delBtn.title = 'Supprimer';
        delBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if(confirm(`Supprimer "${f.title}" ?`)){
            filmsData[i].films.splice(fi, 1);
            saveData();
            renderManage();
            renderAll();
          }
        });
        
        filmActions.appendChild(editBtn);
        filmActions.appendChild(delBtn);
        
        filmItem.appendChild(poster);
        filmItem.appendChild(info);
        filmItem.appendChild(filmActions);
        filmsList.appendChild(filmItem);
      });
    }
    
    // Toggle expand
    header.addEventListener('click', () => {
      const isExpanded = card.classList.contains('expanded');
      // Close all others first
      qsa('.manage-section-card.expanded').forEach(c => {
        if(c !== card){
          c.classList.remove('expanded');
          c.querySelector('.manage-card-films').classList.remove('expanded');
          c.querySelector('.manage-card-expand').classList.remove('expanded');
        }
      });
      // Toggle this one
      card.classList.toggle('expanded');
      filmsList.classList.toggle('expanded');
      expandBtn.classList.toggle('expanded');
    });
    
    card.appendChild(header);
    card.appendChild(filmsList);
    manageList.appendChild(card);
  });
}

/* Edit film */
function editFilm(si, fi){
  const f = filmsData[si].films[fi];
  const t = prompt('Titre', f.title); if(t===null) return;
  const d = prompt('R√©alisateur', f.director||''); if(d===null) return;
  const y = prompt('Ann√©e', f.year||''); if(y===null) return;
  const w = prompt('Wiki (laisser vide auto)', f.wiki||'');
  f.title = t; f.director = d; f.year = y; f.wiki = w ? w : autoWiki(f.title);
  saveData(); renderAll(); renderManage(); renderSeen();
}
function autoWiki(title){ if(!title) return ''; let s = title.replace(/[:(),]/g,'').replace(/\s+/g,'_'); return 'https://fr.wikipedia.org/wiki/' + encodeURIComponent(s); }
function randomColor(){ const letters='456789ABCDEF'; let c='#'; for(let i=0;i<6;i++) c+=letters[Math.floor(Math.random()*letters.length)]; return c; }

/* Poster fetch helper (TMDB search) */
async function fetchPosterForStatic(title, year){
  if(!title) return null;
  try{
    let q = encodeURIComponent(title + (year? ' '+year : ''));
    let r = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&language=fr-FR&query=${q}&page=1&include_adult=false`);
    let j = await r.json();
    if(j && j.results && j.results[0] && j.results[0].poster_path) return TMDB_IMAGE_BASE + 'w300' + j.results[0].poster_path;
    q = encodeURIComponent(title);
    r = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&language=fr-FR&query=${q}&page=1&include_adult=false`);
    j = await r.json();
    if(j && j.results && j.results[0] && j.results[0].poster_path) return TMDB_IMAGE_BASE + 'w300' + j.results[0].poster_path;
  }catch(e){}
  return null;
}

/* ================= TMDB advanced ================= */
async function tmdbFetchGenres(){
  try{
    const r = await fetch(`https://api.themoviedb.org/3/genre/movie/list?api_key=${TMDB_API_KEY}&language=fr-FR`);
    const j = await r.json();
    (j.genres||[]).forEach(g=>{ if(!Array.from(tmdbGenreEl.options).some(o=>o.value==g.id)){ const o=document.createElement('option'); o.value=g.id; o.textContent=g.name; tmdbGenreEl.appendChild(o); } });
  }catch(e){ console.error('tmdbFetchGenres', e); }
}
async function fetchFromEndpoint(endpoint, pagesToFetch=4, extraParams=''){
  let all = [];
  for(let p=1;p<=pagesToFetch;p++){
    try{
      const url = `https://api.themoviedb.org/3/movie/${endpoint}?api_key=${TMDB_API_KEY}&language=fr-FR&page=${p}${extraParams}`;
      const r = await fetch(url); const j = await r.json();
      if(j && j.results && j.results.length) all = all.concat(j.results);
      if(j.page && j.total_pages && j.page >= j.total_pages) break;
    }catch(e){ console.error('fetchFromEndpoint', endpoint, e); break; }
  }
  return all;
}
async function fetchDiscover(pagesToFetch=4){
  let all = []; const today=new Date().toISOString().split('T')[0]; const sixMonthsAgo=new Date(Date.now()-180*24*60*60*1000).toISOString().split('T')[0];
  for(let p=1;p<=pagesToFetch;p++){
    try{
      const url = `https://api.themoviedb.org/3/discover/movie?api_key=${TMDB_API_KEY}&language=fr-FR&page=${p}&region=FR&sort_by=release_date.desc&primary_release_date.gte=${sixMonthsAgo}&primary_release_date.lte=${today}&with_release_type=2|3`;
      const r = await fetch(url); const j = await r.json();
      if(j && j.results && j.results.length) all = all.concat(j.results);
      if(j.page && j.total_pages && j.page >= j.total_pages) break;
    }catch(e){ console.error('fetchDiscover', e); break;
}  }
  return all;
}
async function fetchDirector(movieId){
  try{
    const r = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=${TMDB_API_KEY}&language=fr-FR`);
    const j = await r.json();
    if(j && j.crew){
      const d = j.crew.find(c=> c.job==='Director' || c.job==='R√©alisateur' || c.job==='director');
      return d ? d.name : '';
    }
  }catch(e){}
  return '';
}
function dedupeById(arr){ const seen = new Set(); return arr.filter(it=>{ if(!it||!it.id) return false; if(seen.has(it.id)) return false; seen.add(it.id); return true; }); }

async function fetchTMDBCombined(source='all'){
  if(!tmdbListEl) return;
  tmdbListEl.textContent = 'Chargement TMDB...';
  try{
    let all = [];
    if(source==='all' || source==='now_playing'){ const now = await fetchFromEndpoint('now_playing',4,'&region=FR'); all = all.concat(now.map(m=>({...m,_source:'now_playing'}))); }
    if(source==='all' || source==='upcoming'){ const up = await fetchFromEndpoint('upcoming',4,'&region=FR'); all = all.concat(up.map(m=>({...m,_source:'upcoming'}))); }
    if(source==='all' || source==='popular'){ const pop = await fetchFromEndpoint('popular',4,''); const sixMonthsAgo = new Date(Date.now()-180*24*60*60*1000).toISOString().split('T')[0]; const recentPop = pop.filter(m=> m.release_date && m.release_date >= sixMonthsAgo); all = all.concat(recentPop.map(m=>({...m,_source:'popular'}))); }
    if(source==='all' || source==='recent'){ const disc = await fetchDiscover(4); all = all.concat(disc.map(m=>({...m,_source:'recent'}))); }

    tmdbMovies = dedupeById(all);
    tmdbMovies.sort((a,b)=> (new Date(b.release_date||'1900-01-01')) - (new Date(a.release_date||'1900-01-01')));
    tmdbDisplayed = tmdbMovies.slice();
    displayTMDB(tmdbDisplayed);
    buildCarousel();
    updateCounters();
    console.log('TMDB loaded', tmdbMovies.length);
  }catch(e){ tmdbListEl.textContent='Erreur TMDB'; console.error('fetchTMDBCombined', e); }
}

/* Apply filters */
function applyTmdbFilters(){
  const g = tmdbGenreEl.value; const d = tmdbDateEl.value; const q = (tmdbSearchEl.value||'').trim().toLowerCase();
  let list = tmdbMovies.slice();
  if(g) list = list.filter(m=> (m.genre_ids||[]).includes(parseInt(g)));
  if(d) list = list.filter(m=> m.release_date && m.release_date >= d);
  if(q) list = list.filter(m=> ((m.title||'')+' '+(m.original_title||'')).toLowerCase().includes(q));
  tmdbDisplayed = list;
  displayTMDB(list);
  buildCarousel();
}

/* Display TMDB list + checkbox behavior: when checked mark in localStorage (seen) */
function displayTMDB(list){
  tmdbAllContainer.innerHTML = '';
  tmdbListEl.innerHTML = '';
  if(!list || list.length === 0){ tmdbListEl.textContent = 'Aucun film trouv√©.'; return; }
  const countInfo = el('div','small', `${list.length} film${list.length>1?'s':''} trouv√©${list.length>1?'s':''} sur TMDB`);
  countInfo.style.marginBottom = '10px'; countInfo.style.color='var(--accent)';
  tmdbAllContainer.appendChild(countInfo);
  const staticCount = filmsData.reduce((acc,s)=> acc + (s.films||[]).length, 0);
  for(let i=0;i<list.length;i++){
    const m = list[i];
    const row = el('div','film');
    const num = el('div','num', staticCount + i + 1);
    const cb = document.createElement('input'); cb.type='checkbox';
    const existing = !!localStorage.getItem('tmdb_'+m.id);
    cb.checked = existing;
    cb.style.marginLeft='0';
    cb.addEventListener('change', async ()=>{
      if (cb.checked) {
        const key = 'tmdb_' + m.id;
        const obj = { 
          id: m.id, 
          title: m.title || '', 
          poster: m.poster_path ? (TMDB_IMAGE_BASE + 'w300' + m.poster_path) : null, 
          release_date: m.release_date || '', 
          source: m._source || '', 
          seen: true, 
          rating: 0, 
          seenDate: Date.now() 
        };
        try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){}
        fetchDirector(m.id).then(name=>{
          if(name){
            try{
              const cur = JSON.parse(localStorage.getItem(key)||'{}');
              cur.director = name;
              cur.seen = true;
              cur.rating = cur.rating || 0;
              cur.seenDate = cur.seenDate || Date.now();
              localStorage.setItem(key, JSON.stringify(cur));
            }catch(e){}
            updateCounters();
            renderSeen();
            updateTmdbWatchedUI();
          }
        });
        updateCounters(); renderSeen(); updateTmdbWatchedUI();
      } else {
        // Option A: remove from localStorage entirely
        try{ localStorage.removeItem('tmdb_'+m.id); }catch(e){}
        updateCounters(); renderSeen(); updateTmdbWatchedUI();
      }
    });
    const poster = el('img','poster-mid'); if(m.poster_path) poster.src = TMDB_IMAGE_BASE + 'w300' + m.poster_path; else poster.style.display='none';
    const txt = el('div',null);
    const title = el('div','title', m.title || m.name || '');
    title.style.fontSize='16px';
    if(m._source){ const badge = el('span','small', ` [${m._source}]`); badge.style.marginLeft='6px'; badge.style.color='#ffd54f'; title.appendChild(badge); }
    const dir = el('div','meta','R√©alisateur: ‚Ä¶'); fetchDirector(m.id).then(name=>{ if(name) dir.textContent = 'R√©alisateur: ' + name; });
    const date = el('div','meta', m.release_date ? `Sortie: ${m.release_date}` : '');
    // Watch button for TMDB films
    const watchBtn = el('span','watch-link','‚ñ∂ Watch'); watchBtn.title='Regarder sur watchseries.bar';
    watchBtn.style.marginTop='4px'; watchBtn.style.display='inline-block';
    watchBtn.addEventListener('click', ()=> openWatchseries(m.title || m.name, m.id, m.release_date ? m.release_date.split('-')[0] : ''));
    txt.appendChild(title); txt.appendChild(dir); txt.appendChild(date); txt.appendChild(watchBtn);
    row.appendChild(num); row.appendChild(cb); row.appendChild(poster); row.appendChild(txt);
    tmdbAllContainer.appendChild(row);
  }
  updateTmdbWatchedUI();
}

/* Render TMDB watched list view */
function updateTmdbWatchedUI(){
  const container = tmdbWatchedContainer;
  if(!container) return;
  container.innerHTML = '';
  const ids = [];
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k && k.startsWith('tmdb_')) ids.push(k.replace('tmdb_',''));
  }
  if(ids.length === 0){ container.textContent = 'Aucun film TMDB marqu√© comme vu.'; return; }

  // Build rows with ability to add to a section and to uncheck (remove)
  ids.forEach(id=>{
    try{
      const v = JSON.parse(localStorage.getItem('tmdb_'+id));
      const row = el('div','film');
      const n = el('div','num', '#'+id);
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = true; cb.style.marginLeft='0';
      cb.addEventListener('change', ()=>{
        // Option A: remove localStorage entry
        try{ localStorage.removeItem('tmdb_'+id); }catch(e){}
        updateCounters(); renderSeen(); updateTmdbWatchedUI(); displayTMDB(tmdbDisplayed);
      });
      const img = el('img'); if(v && v.poster){ img.src = v.poster; img.style.width='64px'; } else img.style.display='none';
      const info = el('div', null);
      const t = el('div','title', v.title + (v.release_date? ' ('+(v.release_date.split('-')[0]) +')' : ''));
      const m = el('div','meta', v.director || '');
      info.appendChild(t); info.appendChild(m);
      // add-to-section UI
      const addSectionWrap = el('div',null);
      const sel = document.createElement('select'); sel.style.marginLeft='8px';
      filmsData.forEach((s,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent = s.section; sel.appendChild(o); });
      const addBtn = el('button','button','Ajouter √† une section'); addBtn.style.marginLeft='6px';
      addBtn.addEventListener('click', ()=>{
        const idx = parseInt(sel.value,10);
        const newFilm = { title: v.title, director: v.director||'', year: v.release_date ? v.release_date.split('-')[0] : '', wiki: v.wiki || '', poster: v.poster || null, tmdbId: parseInt(id,10) || null, seen: true, seenDate: v.seenDate || Date.now() };
        filmsData[idx].films.push(newFilm);
        saveData();
        updateCounters();
        renderAll();
        renderSeen();
        alert(`Ajout√© √† la section "${filmsData[idx].section}"`);
      });

      row.appendChild(n); row.appendChild(cb); row.appendChild(img); row.appendChild(info);
      addSectionWrap.appendChild(sel); addSectionWrap.appendChild(addBtn);
      row.appendChild(addSectionWrap);
      container.appendChild(row);
    }catch(e){}
  });
}

/* Carousel build/start */
function buildCarousel(){
  if(!carouselTrack) return;
  carouselTrack.innerHTML = '';
  const posters = tmdbMovies.filter(m=>m.poster_path).map(m=> TMDB_IMAGE_BASE + 'w500' + m.poster_path);
  let items = posters.slice();
  // Duplicate images twice for seamless infinite scrolling
  items = items.concat(items);
  items.forEach(src=>{ const img=document.createElement('img'); img.src = src; carouselTrack.appendChild(img); });
  if(posters[0]) carouselBg.style.backgroundImage = `url(${posters[0]})`;
  startCarousel();
}
function startCarousel(){
  const wrap = document.getElementById('carousel-wrap');
  const track = document.getElementById('carousel-track');
  if(!wrap||!track) return;
  if(carouselRAF) cancelAnimationFrame(carouselRAF);
  let offset = 0;
  const speed = 0.35;
  function step(){
    offset -= speed;
    // When fully scrolled past first set of images, reset to create infinite loop
    if(Math.abs(offset) >= track.scrollWidth / 2){
      offset = 0;
    }
    track.style.transform = `translateX(${offset}px)`;
    carouselRAF = requestAnimationFrame(step);
  }
  wrap.onmouseenter = ()=>{ if(carouselRAF) cancelAnimationFrame(carouselRAF); };
  wrap.onmouseleave = ()=>{ offset = parseFloat(track.style.transform.replace(/[^\d.-]/g, '') || 0); carouselRAF = requestAnimationFrame(step); };
  carouselRAF = requestAnimationFrame(step);
}

/* Setup tab buttons and actions */
qsa('.tab-btn').forEach(btn => btn.addEventListener('click', ()=>{
  qsa('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  
  const id = btn.dataset.tab;
  const targetEl = document.getElementById(id);
  
  // Fade out current tab
  const currentTab = document.querySelector('[data-tabcontent]:not([style*="display: none"])');
  if(currentTab && currentTab !== targetEl){
    currentTab.style.animation = 'fadeOut 0.2s ease-out';
    setTimeout(() => {
      qsa('[data-tabcontent]').forEach(c => c.style.display = 'none');
      if(targetEl){
        targetEl.style.display = 'block';
        targetEl.style.animation = 'fadeIn 0.3s ease-in forwards';
      }
      if(id==='tmdb'){ tmdbFetchGenres(); fetchTMDBCombined(currentTmdbSource); }
    }, 200);
  } else {
    qsa('[data-tabcontent]').forEach(c => c.style.display = 'none');
    if(targetEl){
      targetEl.style.display = 'block';
      targetEl.style.animation = 'fadeIn 0.3s ease-in forwards';
    }
    if(id==='tmdb'){ tmdbFetchGenres(); fetchTMDBCombined(currentTmdbSource); }
  }
}));

/* All search - live search like TMDB */
qs('#all-search').addEventListener('input', (e)=>{ allSearchQuery = e.target.value || ''; renderAll(); });
qs('#all-reset-btn').addEventListener('click', ()=>{ allSearchQuery=''; qs('#all-search').value=''; renderAll(); });

/* Manage create section */
qs('#create-section')?.addEventListener('click', ()=>{ const n = addSectionInput.value.trim(); if(!n){ alert('Nom requis'); return; } filmsData.push({ section: n, color: randomColor(), films: [] }); saveData(); renderAll(); renderManage(); populateSectionSelects(); addSectionInput.value=''; });

/* Global add film (with intelligent autofill: debounce 300ms, overwrites fields) */
const addTitle = qs('#add-title'), addDirector = qs('#add-director'), addYear = qs('#add-year'), addWiki = qs('#add-wiki'), addSectionSelect = qs('#add-section-select'), addFilmBtn = qs('#add-film-btn');
let addDebounce = null;
addTitle.addEventListener('input', ()=> {
  clearTimeout(addDebounce);
  addDebounce = setTimeout(async ()=>{
    const q = addTitle.value.trim();
    if(!q) return;
    const details = await fetchTMDBDetailsByTitle(q);
    if(details){
      // Overwrite fields as requested
      addDirector.value = details.director || '';
      addYear.value = details.year || '';
      addTitle.dataset.poster = details.poster || '';
      addTitle.dataset.tmdbId = details.tmdbId || '';
      addWiki.value = details.wiki || (details.title ? autoWiki(details.title) : '');
    }
  }, 300); // 300ms debounce -> very reactive, close to "every letter"
});
addTitle.addEventListener('blur', async ()=> {
  clearTimeout(addDebounce);
  const q = addTitle.value.trim();
  if(!q) return;
  const details = await fetchTMDBDetailsByTitle(q);
  if(details){
    addDirector.value = details.director || '';
    addYear.value = details.year || '';
    addTitle.dataset.poster = details.poster || '';
    addTitle.dataset.tmdbId = details.tmdbId || '';
    addWiki.value = details.wiki || (details.title ? autoWiki(details.title) : '');
  }
});

addFilmBtn.addEventListener('click', async ()=>{
  const title = addTitle.value.trim(); if(!title){ alert('Titre requis'); return; }
  let director = addDirector.value.trim(); let year = addYear.value.trim(); let wiki = addWiki.value.trim();
  let tmdbId = addTitle.dataset.tmdbId ? parseInt(addTitle.dataset.tmdbId,10) : null;
  const si = parseInt(addSectionSelect.value||0,10);
  if(!director || !year || !wiki || !tmdbId){
    const details = await fetchTMDBDetailsByTitle(title);
    if(details){
      if(!director) director = details.director;
      if(!year) year = details.year;
      if(!wiki) wiki = details.wiki;
      if(!tmdbId && details.tmdbId) tmdbId = details.tmdbId;
      if(details.poster) addTitle.dataset.poster = addTitle.dataset.poster || details.poster;
    }
  }
  if(!wiki) wiki = autoWiki(title);
  const film = { title, director, year, wiki, poster: addTitle.dataset.poster || null, tmdbId: tmdbId || null, seen:false };
  filmsData[si].films.push(film); saveData();
  const p = await fetchPosterForStatic(title, year); if(p){ film.poster = p; saveData(); }
  renderAll(); renderManage(); renderSeen();
  addTitle.value=''; addDirector.value=''; addYear.value=''; addWiki.value=''; addTitle.dataset.poster=''; addTitle.dataset.tmdbId='';
});

/* Additional add buttons - manage-add-btn opens a global inline form */
qs('#seen-add-btn')?.addEventListener('click', ()=> openGlobalInlineAdd());
qs('#manage-add-btn')?.addEventListener('click', ()=> {
  const existing = document.querySelector('#manage-inline-add');
  if(existing){ existing.remove(); return; }
  const container = manageList;
  const f = el('div','inline-form'); f.id='manage-inline-add';
  const sel = document.createElement('select');
  filmsData.forEach((s,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=s.section; sel.appendChild(o); });
  const t=document.createElement('input'); t.placeholder='Titre';
  const d=document.createElement('input'); d.placeholder='R√©alisateur';
  const y=document.createElement('input'); y.placeholder='Ann√©e';
  const w=document.createElement('input'); w.placeholder='Wiki (optionnel)';
  let mTimer=null;
  t.addEventListener('input', ()=>{ clearTimeout(mTimer); mTimer=setTimeout(async ()=>{ const details = await fetchTMDBDetailsByTitle(t.value.trim()); if(details){ d.value = details.director || ''; y.value = details.year || ''; w.value = details.wiki || ''; t.dataset.poster = details.poster || t.dataset.poster; t.dataset.tmdbId = details.tmdbId || ''; } }, 300); });
  const ok = el('button','button','Ajouter'); ok.addEventListener('click', async ()=>{
    const idx = parseInt(sel.value,10);
    const newFilm={ title:t.value.trim(), director:d.value.trim(), year:y.value.trim(), wiki:w.value.trim() || autoWiki(t.value.trim()), poster:t.dataset.poster||null, tmdbId:t.dataset.tmdbId ? parseInt(t.dataset.tmdbId,10) : null, seen:false };
    if(!newFilm.title){ alert('Titre requis'); return; }
    filmsData[idx].films.push(newFilm);
    saveData(); renderAll(); renderManage(); renderSeen(); f.remove(); populateSectionSelects();
  });
  const cancel=el('button','action-btn','Annuler'); cancel.addEventListener('click', ()=> f.remove());
  f.appendChild(sel); f.appendChild(t); f.appendChild(d); f.appendChild(y); f.appendChild(w); f.appendChild(ok); f.appendChild(cancel);
  container.prepend(f);
});
floatingAddBtn.addEventListener('click', ()=> openGlobalInlineAdd());
headerAddBtn.addEventListener('click', ()=> { window.location.hash = '#global-add-film'; qs('#add-title').focus(); });

function openGlobalInlineAdd(){
  qsa('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector('.tab-btn[data-tab="all"]').classList.add('active');
  
  const currentTab = document.querySelector('[data-tabcontent]:not([style*="display: none"])');
  const allTab = document.getElementById('all');
  
  if(currentTab && currentTab !== allTab && allTab){
    currentTab.style.animation = 'fadeOut 0.2s ease-out';
    setTimeout(() => {
      qsa('[data-tabcontent]').forEach(c=>c.style.display='none');
      allTab.style.display='block';
      allTab.style.animation = 'fadeIn 0.3s ease-in forwards';
      document.getElementById('global-add-film').scrollIntoView({behavior:'smooth', block:'center'});
      qs('#add-title').focus();
    }, 200);
  } else {
    qsa('[data-tabcontent]').forEach(c=>c.style.display='none');
    if(allTab){
      allTab.style.display='block';
      allTab.style.animation = 'fadeIn 0.3s ease-in forwards';
    }
    document.getElementById('global-add-film').scrollIntoView({behavior:'smooth', block:'center'});
    qs('#add-title').focus();
  }
}

/* TMDB bindings */
qs('#tmdb-filter')?.addEventListener('click', ()=> applyTmdbFilters());
qs('#tmdb-refresh')?.addEventListener('click', ()=> fetchTMDBCombined(currentTmdbSource));
tmdbSourceEl.addEventListener('change', (e)=>{ currentTmdbSource = e.target.value; fetchTMDBCombined(currentTmdbSource); });
tmdbSearchEl.addEventListener('input', ()=> applyTmdbFilters());

/* Subtab buttons for TMDB */
tmdbSubAllBtn.addEventListener('click', ()=> { tmdbAllContainer.style.display='block'; tmdbWatchedContainer.style.display='none'; tmdbSubAllBtn.classList.add('active'); tmdbSubWatchedBtn.classList.remove('active'); });
tmdbSubWatchedBtn.addEventListener('click', ()=> { tmdbAllContainer.style.display='none'; tmdbWatchedContainer.style.display='block'; tmdbSubWatchedBtn.classList.add('active'); tmdbSubAllBtn.classList.remove('active'); updateTmdbWatchedUI(); });

/* Populate section selects */
function populateSectionSelects(){
  const sel = qs('#add-section-select'); if(sel){ sel.innerHTML=''; filmsData.forEach((s,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent = s.section; sel.appendChild(o); }); }
}

/* initial render */
renderAll(); renderSeen(); renderManage(); populateSectionSelects(); updateCounters();

/* TMDB initial */
tmdbFetchGenres(); fetchTMDBCombined(currentTmdbSource);

/* auto refresh TMDB when active every 10 minutes */
setInterval(()=>{ const active = document.querySelector('.tab-btn.active')?.dataset?.tab; if(active==='tmdb') fetchTMDBCombined(currentTmdbSource); }, 10*60*1000);

/* ================= Utility: fetch TMDB details by title (director, year, poster, wiki) ================= */
async function fetchTMDBDetailsByTitle(title, targetYear){
  if(!title) return null;
  try{
    const q = encodeURIComponent(title);
    // Use TMDB's year parameter if targetYear is provided for more accurate results
    let url = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&language=fr-FR&query=${q}&page=1&include_adult=false`;
    if(targetYear) url += `&year=${targetYear}`;
    const r = await fetch(url);
    const j = await r.json();
    if(!j || !j.results || j.results.length === 0) {
      // If no results with year filter, try without year
      if(targetYear) {
        const r2 = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&language=fr-FR&query=${q}&page=1&include_adult=false`);
        const j2 = await r2.json();
        if(!j2 || !j2.results || j2.results.length === 0) return null;
        // Find the best match by year if possible
        let movie = j2.results[0];
        if(targetYear) {
          const yearMatch = j2.results.find(m => m.release_date && m.release_date.startsWith(targetYear));
          if(yearMatch) movie = yearMatch;
        }
        const year = movie.release_date ? movie.release_date.split('-')[0] : '';
        const poster = movie.poster_path ? (TMDB_IMAGE_BASE + 'w300' + movie.poster_path) : null;
        let director = '';
        try{ director = await fetchDirector(movie.id); }catch(e){}
        let wiki = await fetchWikipedia(movie.title).catch(()=> null);
        if(!wiki) wiki = autoWiki(movie.title);
        return { director, year, poster, wiki, title: movie.title || title, tmdbId: movie.id };
      }
      return null;
    }
    const movie = j.results[0];
    const year = movie.release_date ? movie.release_date.split('-')[0] : '';
    const poster = movie.poster_path ? (TMDB_IMAGE_BASE + 'w300' + movie.poster_path) : null;
    let director = '';
    try{ director = await fetchDirector(movie.id); }catch(e){}
    let wiki = await fetchWikipedia(movie.title).catch(()=> null);
    if(!wiki) wiki = autoWiki(movie.title);
    return { director, year, poster, wiki, title: movie.title || title, tmdbId: movie.id };
  }catch(e){ console.error('fetchTMDBDetailsByTitle', e); return null; }
}

/* Wikipedia opensearch to find a probable FR wiki page */
async function fetchWikipedia(title){
  if(!title) return '';
  try{
    const url = `https://fr.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(title)}&limit=1&namespace=0&format=json&origin=*`;
    const r = await fetch(url);
    const j = await r.json();
    if(Array.isArray(j) && j[3] && j[3][0]) return j[3][0];
  }catch(e){ console.error('fetchWikipedia', e); }
  return '';
}
</script>
</body>
</html>
